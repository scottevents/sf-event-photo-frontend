<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - SF Event Photo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --black:#1a1a1a; --white:#fff; --gray-50:#f9fafb; --gray-100:#f3f4f6; --gray-200:#e5e7eb; --gray-300:#d1d5db; --gray-400:#9ca3af; --gray-500:#6b7280; --gray-600:#4b5563; --accent:#14b8a6; --accent-dark:#0d9488; --danger:#ef4444; --success:#10b981; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',-apple-system,sans-serif; background:var(--gray-50); color:var(--black); min-height:100vh; }
        
        .login-screen { min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--gray-100); }
        .login-box { background:white; padding:3rem; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.08); width:100%; max-width:400px; text-align:center; }
        .login-box h1 { font-size:1.5rem; font-weight:600; margin-bottom:0.5rem; }
        .login-box p { color:var(--gray-500); margin-bottom:2rem; }
        .login-box input { width:100%; padding:0.875rem 1rem; border:1px solid var(--gray-200); border-radius:8px; font-size:1rem; margin-bottom:1rem; }
        .login-box input:focus { outline:none; border-color:var(--accent); }
        .login-box button { width:100%; padding:0.875rem; background:var(--accent); color:white; border:none; border-radius:8px; font-size:1rem; font-weight:600; cursor:pointer; }
        .login-box button:hover { background:var(--accent-dark); }
        .login-error { color:var(--danger); margin-bottom:1rem; display:none; font-size:0.9rem; }
        
        .dashboard { display:none; }
        .dashboard.active { display:flex; min-height:100vh; }
        
        .sidebar { width:240px; background:white; border-right:1px solid var(--gray-200); display:flex; flex-direction:column; position:fixed; top:0; left:0; bottom:0; z-index:100; }
        .sidebar-header { padding:1.25rem 1.5rem; border-bottom:1px solid var(--gray-200); display:flex; align-items:center; gap:0.75rem; }
        .sidebar-header .logo { width:32px; height:32px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; }
        .sidebar-header span { font-weight:600; font-size:0.95rem; }
        .sidebar-nav { padding:1rem 0; flex:1; }
        .nav-item { display:flex; align-items:center; gap:0.75rem; padding:0.75rem 1.5rem; color:var(--gray-600); text-decoration:none; font-size:0.9rem; font-weight:500; cursor:pointer; border:none; background:none; width:100%; text-align:left; }
        .nav-item:hover { background:var(--gray-50); color:var(--black); }
        .nav-item.active { background:var(--gray-100); color:var(--accent); }
        .nav-item svg { width:20px; height:20px; opacity:0.7; }
        .nav-item.active svg { opacity:1; }
        .sidebar-footer { padding:1rem 1.5rem; border-top:1px solid var(--gray-200); }
        .sidebar-footer a { display:block; color:var(--gray-500); text-decoration:none; font-size:0.85rem; margin-bottom:0.5rem; }
        .sidebar-footer a:hover { color:var(--black); }
        
        .main-content { flex:1; margin-left:240px; min-height:100vh; }
        .main-header { background:white; border-bottom:1px solid var(--gray-200); padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:50; }
        .main-header h1 { font-size:1.5rem; font-weight:600; }
        .main-header-actions { display:flex; gap:0.75rem; align-items:center; }
        
        .btn { padding:0.6rem 1.25rem; border-radius:6px; font-size:0.875rem; font-weight:500; cursor:pointer; display:inline-flex; align-items:center; gap:0.5rem; border:none; transition:all 0.15s; }
        .btn-primary { background:var(--accent); color:white; }
        .btn-primary:hover { background:var(--accent-dark); }
        .btn-secondary { background:var(--gray-100); color:var(--gray-700); }
        .btn-secondary:hover { background:var(--gray-200); }
        .btn-danger { background:var(--danger); color:white; }
        .btn-sm { padding:0.4rem 0.75rem; font-size:0.8rem; }
        
        .page-content { padding:2rem; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        
        .collections-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:1.5rem; }
        .collection-card { background:white; border-radius:12px; overflow:hidden; box-shadow:0 1px 3px rgba(0,0,0,0.08); cursor:pointer; transition:all 0.2s; position:relative; }
        .collection-card:hover { box-shadow:0 4px 12px rgba(0,0,0,0.12); transform:translateY(-2px); }
        .collection-card.dragging { opacity:0.5; transform:scale(0.98); }
        .collection-card.drag-over { border:2px dashed var(--accent); transform:scale(1.02); }
        .collection-card .drag-handle { position:absolute; top:8px; right:8px; width:28px; height:28px; background:rgba(255,255,255,0.9); border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:grab; opacity:0; transition:opacity 0.2s; z-index:5; }
        .collection-card:hover .drag-handle { opacity:1; }
        .collection-card .drag-handle:active { cursor:grabbing; }
        .collection-card .drag-handle svg { width:16px; height:16px; color:var(--gray-500); }
        .collection-cover { aspect-ratio:16/10; background:var(--gray-200); position:relative; overflow:hidden; }
        .collection-cover img { width:100%; height:100%; object-fit:cover; }
        .collection-status { position:absolute; top:12px; left:12px; padding:0.25rem 0.6rem; border-radius:4px; font-size:0.7rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; }
        .collection-status.published { background:var(--accent); color:white; }
        .collection-status.draft { background:var(--gray-600); color:white; }
        .collection-featured { position:absolute; top:12px; right:40px; padding:0.25rem 0.6rem; border-radius:4px; font-size:0.7rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; background:#f59e0b; color:white; }
        .collection-remove { position:absolute; bottom:12px; right:12px; width:28px; height:28px; background:rgba(239,68,68,0.9); border-radius:6px; border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.2s; z-index:5; color:white; font-size:1.1rem; font-weight:bold; }
        .collection-card:hover .collection-remove { opacity:1; }
        .collection-remove:hover { background:var(--danger); }
        .available-project-item { display:flex; align-items:center; gap:1rem; padding:0.75rem; border:1px solid var(--gray-200); border-radius:8px; margin-bottom:0.5rem; cursor:pointer; transition:all 0.15s; }
        .available-project-item:hover { background:var(--gray-50); border-color:var(--accent); }
        .available-project-item img { width:60px; height:45px; object-fit:cover; border-radius:4px; background:var(--gray-200); }
        .available-project-item-info { flex:1; }
        .available-project-item-title { font-weight:500; font-size:0.9rem; margin-bottom:0.15rem; }
        .available-project-item-meta { font-size:0.75rem; color:var(--gray-500); }
        .collection-info { padding:1rem 1.25rem; }
        .collection-title { font-size:1rem; font-weight:600; margin-bottom:0.35rem; color:var(--black); }
        .collection-meta { display:flex; align-items:center; gap:0.5rem; font-size:0.8rem; color:var(--gray-500); }
        .collection-meta .dot { width:4px; height:4px; background:var(--gray-400); border-radius:50%; }
        .collection-meta .count { display:flex; align-items:center; gap:0.25rem; }
        .collection-meta .count::before { content:''; width:8px; height:8px; background:var(--accent); border-radius:50%; }
        
        .project-header { display:flex; align-items:center; gap:1rem; }
        .back-btn { width:36px; height:36px; border-radius:8px; border:1px solid var(--gray-200); background:white; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        .back-btn:hover { background:var(--gray-50); }
        .project-header-info h2 { font-size:1.25rem; font-weight:600; }
        .project-header-info p { font-size:0.85rem; color:var(--gray-500); }
        
        .project-layout { display:flex; gap:2rem; }
        .project-sidebar { width:280px; flex-shrink:0; }
        .project-cover-preview { aspect-ratio:16/10; border-radius:8px; overflow:hidden; background:var(--gray-200); margin-bottom:1rem; }
        .project-cover-preview img { width:100%; height:100%; object-fit:cover; }
        .sidebar-section { margin-bottom:1.5rem; }
        .sidebar-section-title { font-size:0.7rem; font-weight:600; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-400); margin-bottom:0.5rem; }
        
        .sidebar-tabs { display:flex; border-bottom:1px solid var(--gray-200); margin-bottom:1rem; }
        .sidebar-tab { flex:1; padding:0.6rem 0.5rem; font-size:0.8rem; font-weight:500; color:var(--gray-500); cursor:pointer; border:none; background:none; border-bottom:2px solid transparent; margin-bottom:-1px; text-align:center; }
        .sidebar-tab:hover { color:var(--black); }
        .sidebar-tab.active { color:var(--accent); border-bottom-color:var(--accent); }
        .sidebar-tab-content { display:none; }
        .sidebar-tab-content.active { display:block; }
        
        .seo-hint { font-size:0.7rem; color:var(--gray-500); margin-top:0.25rem; margin-bottom:0.5rem; }
        .seo-google-preview { background:white; border:1px solid var(--gray-200); border-radius:8px; padding:0.75rem; margin-bottom:0.5rem; }
        .seo-preview-title { color:#1a0dab; font-size:0.9rem; font-weight:500; margin-bottom:0.15rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .seo-preview-url { color:#006621; font-size:0.75rem; margin-bottom:0.25rem; }
        .seo-preview-desc { color:#545454; font-size:0.8rem; line-height:1.4; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
        .seo-tips-list { margin:0; padding-left:1.25rem; font-size:0.75rem; color:var(--gray-600); }
        .seo-tips-list li { margin-bottom:0.4rem; line-height:1.4; }
        .seo-tips-list strong { color:var(--black); }
        .seo-schema-code { background:var(--gray-50) !important; }
        
        /* Multi-step modal */
        .modal-steps { display:flex; gap:0.5rem; margin-bottom:1.5rem; padding-bottom:1rem; border-bottom:1px solid var(--gray-200); }
        .modal-step { display:flex; align-items:center; gap:0.5rem; font-size:0.85rem; color:var(--gray-400); font-weight:500; }
        .modal-step.active { color:var(--accent); }
        .modal-step.completed { color:var(--success); }
        .step-num { width:24px; height:24px; border-radius:50%; background:var(--gray-200); display:flex; align-items:center; justify-content:center; font-size:0.75rem; font-weight:600; }
        .modal-step.active .step-num { background:var(--accent); color:white; }
        .modal-step.completed .step-num { background:var(--success); color:white; }
        .step-content { display:none; }
        .step-content.active { display:block; }
        
        /* SEO Best Practices Box */
        .seo-best-practices-box { background:linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); border:1px solid #bbf7d0; border-radius:10px; padding:1rem 1.25rem; margin-bottom:1.25rem; }
        .seo-bp-title { font-weight:600; font-size:0.9rem; color:#166534; margin-bottom:0.6rem; }
        .seo-bp-list { margin:0; padding-left:1.25rem; font-size:0.8rem; color:#15803d; line-height:1.5; }
        .seo-bp-list li { margin-bottom:0.4rem; }
        .seo-bp-list strong { color:#166534; }
        
        /* Field hints and char counts */
        .field-hint { font-size:0.7rem; color:var(--gray-500); margin-top:0.35rem; }
        .char-count { font-weight:400; color:var(--gray-400); font-size:0.8rem; }
        
        /* SEO Preview Box in modal */
        .seo-preview-box { background:white; border:1px solid var(--gray-200); border-radius:8px; padding:0.875rem; margin-top:0.5rem; }
        .seo-preview-label { font-size:0.65rem; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-400); margin-bottom:0.5rem; font-weight:600; }
        
        .activity-list { max-height:300px; overflow-y:auto; }
        .activity-item { padding:0.6rem 0; border-bottom:1px solid var(--gray-100); font-size:0.8rem; }
        .activity-item:last-child { border-bottom:none; }
        .activity-email { font-weight:500; color:var(--black); word-break:break-all; }
        .activity-meta { color:var(--gray-500); font-size:0.7rem; margin-top:0.2rem; }
        .activity-file { color:var(--gray-600); font-size:0.75rem; font-family:monospace; margin-top:0.15rem; background:var(--gray-100); padding:0.15rem 0.4rem; border-radius:3px; display:inline-block; }
        .activity-type { display:inline-block; padding:0.1rem 0.4rem; border-radius:3px; font-size:0.65rem; font-weight:600; text-transform:uppercase; }
        .activity-type.download { background:#dbeafe; color:#1e40af; }
        .activity-type.single { background:#dbeafe; color:#1e40af; }
        .activity-type.gallery { background:#fef3c7; color:#92400e; }
        .activity-type.purchase { background:#d1fae5; color:#065f46; }
        
        /* License management */
        .licenses-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .license-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 6px;
            border: 1px solid var(--gray-200);
        }
        
        .license-item-info {
            flex: 1;
        }
        
        .license-item-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }
        
        .license-item-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }
        
        .license-item-desc {
            font-size: 0.8rem;
            color: var(--gray-500);
            line-height: 1.4;
        }
        
        .license-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .license-item-actions button {
            background: none;
            border: none;
            color: var(--gray-400);
            cursor: pointer;
            padding: 0.25rem;
            font-size: 0.9rem;
        }
        
        .license-item-actions button:hover {
            color: var(--gray-600);
        }
        
        .license-item-actions button.delete:hover {
            color: var(--danger);
        }
        
        .add-license-form {
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 6px;
            border: 1px solid var(--gray-200);
            margin-top: 0.75rem;
        }
        
        /* Project license toggles */
        .project-licenses-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .project-license-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: var(--gray-50);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        
        .project-license-item label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        
        .project-license-item .price {
            color: var(--gray-500);
            font-size: 0.8rem;
        }
        
        /* Video management */
        .video-list { margin-top: 0.5rem; }
        .video-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--gray-50);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }
        .video-item-thumb {
            width: 60px;
            height: 34px;
            background: var(--gray-200);
            border-radius: 3px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .video-item-thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-item-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        .video-item-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .video-item-url {
            font-size: 0.7rem;
            color: var(--gray-500);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .video-item-remove {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.25rem;
            line-height: 1;
        }
        .video-item-remove:hover { opacity: 0.7; }
        .add-video-row {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .add-video-row input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .add-video-row button {
            padding: 0.5rem 0.75rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
        }
        .add-video-row button:hover { background: var(--accent-dark); }
        .sidebar-input { width:100%; padding:0.6rem 0.75rem; border:1px solid var(--gray-200); border-radius:6px; font-size:0.875rem; margin-bottom:0.75rem; }
        .sidebar-input:focus { outline:none; border-color:var(--accent); }
        
        .domains-list { display:flex; flex-wrap:wrap; gap:0.4rem; margin-bottom:0.5rem; min-height:28px; }
        .domain-tag { display:inline-flex; align-items:center; gap:0.3rem; background:#dbeafe; color:#1e40af; padding:0.2rem 0.5rem; border-radius:4px; font-size:0.75rem; font-family:monospace; }
        .domain-tag button { background:none; border:none; color:#1e40af; cursor:pointer; padding:0; font-size:0.9rem; line-height:1; opacity:0.6; }
        .domain-tag button:hover { opacity:1; }
        .add-domain-row { display:flex; gap:0.4rem; }
        .add-domain-row input { flex:1; padding:0.4rem 0.6rem; border:1px solid var(--gray-200); border-radius:4px; font-family:monospace; font-size:0.8rem; }
        .add-domain-row button { padding:0.4rem 0.6rem; background:var(--accent); color:white; border:none; border-radius:4px; font-size:0.75rem; font-weight:600; cursor:pointer; }
        
        .project-photos { flex:1; }
        .photos-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; }
        .photos-header h3 { font-size:1rem; font-weight:600; }
        .photos-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(180px, 1fr)); gap:1rem; }
        .photo-card { background:white; border-radius:8px; overflow:hidden; border:1px solid var(--gray-200); transition:border-color 0.2s, transform 0.15s, opacity 0.15s; cursor:grab; position:relative; }
        .photo-card:hover { border-color:var(--accent); }
        .photo-card.is-cover { border-color:var(--accent); border-width:2px; }
        .photo-card.dragging { opacity:0.4; transform:scale(0.95); }
        .photo-card.drag-over { border-color:var(--accent); border-width:2px; border-style:dashed; transform:scale(1.02); }
        .photo-card.selected { border-color:var(--accent); border-width:2px; background:#f0f7ff; }
        .photo-select-checkbox { position:absolute; top:8px; left:8px; z-index:10; width:22px; height:22px; border-radius:4px; border:2px solid rgba(255,255,255,0.8); background:rgba(0,0,0,0.3); cursor:pointer; display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.15s; }
        .photo-card:hover .photo-select-checkbox, .photo-card.selected .photo-select-checkbox, .select-mode .photo-select-checkbox { opacity:1; }
        .photo-select-checkbox.checked { background:var(--accent); border-color:var(--accent); }
        .photo-select-checkbox svg { width:14px; height:14px; color:white; display:none; }
        .photo-select-checkbox.checked svg { display:block; }
        
        .bulk-action-bar { display:none; align-items:center; gap:0.75rem; padding:0.6rem 1rem; background:var(--accent); border-radius:8px; margin-bottom:1rem; color:white; font-size:0.8rem; }
        .bulk-action-bar.show { display:flex; }
        .bulk-action-bar .bulk-count { font-weight:600; margin-right:auto; }
        .bulk-action-bar button { padding:0.35rem 0.75rem; border:1px solid rgba(255,255,255,0.4); background:rgba(255,255,255,0.15); color:white; border-radius:4px; font-size:0.75rem; font-weight:500; cursor:pointer; white-space:nowrap; }
        .bulk-action-bar button:hover { background:rgba(255,255,255,0.3); }
        .bulk-action-bar button.danger { border-color:rgba(255,100,100,0.6); background:rgba(255,50,50,0.3); }
        .bulk-action-bar button.danger:hover { background:rgba(255,50,50,0.5); }
        .bulk-action-bar select { padding:0.35rem 0.5rem; border:1px solid rgba(255,255,255,0.4); background:rgba(255,255,255,0.15); color:white; border-radius:4px; font-size:0.75rem; cursor:pointer; }
        .bulk-action-bar select option { color:var(--black); }
        .photo-thumb { aspect-ratio:4/3; background:var(--gray-100); position:relative; }
        .photo-thumb img { width:100%; height:100%; object-fit:cover; }
        .photo-cover-badge { position:absolute; top:6px; left:6px; background:var(--accent); color:white; font-size:0.65rem; font-weight:600; padding:0.15rem 0.4rem; border-radius:3px; }
        .photo-actions-overlay { position:absolute; top:6px; right:6px; display:flex; gap:4px; opacity:0; transition:opacity 0.2s; }
        .photo-card:hover .photo-actions-overlay { opacity:1; }
        .photo-action-btn { width:28px; height:28px; border-radius:4px; border:none; background:rgba(0,0,0,0.6); color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.75rem; }
        .photo-action-btn:hover { background:rgba(0,0,0,0.8); }
        .photo-body { padding:0.75rem; }
        .photo-set-select { width:100%; padding:0.4rem; border:1px solid var(--gray-200); border-radius:4px; font-size:0.75rem; margin-bottom:0.5rem; background:white; color:var(--gray-600); }
        .photo-set-select:focus { outline:none; border-color:var(--accent); }
        .photo-tags-input { width:100%; padding:0.5rem; border:1px solid var(--gray-200); border-radius:4px; font-size:0.8rem; margin-bottom:0.5rem; }
        .photo-tags-input:focus { outline:none; border-color:var(--accent); }
        .photo-tags-input::placeholder { color:var(--gray-400); }
        .photo-save-btn { width:100%; padding:0.4rem; background:var(--gray-100); border:none; border-radius:4px; font-size:0.75rem; font-weight:500; color:var(--gray-600); cursor:pointer; }
        .photo-save-btn:hover { background:var(--accent); color:white; }
        
        /* Sets Management */
        .sets-manager { margin-bottom:1.5rem; padding:1rem; background:var(--gray-50); border-radius:8px; }
        .sets-manager-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem; }
        .sets-manager-title { font-size:0.8rem; font-weight:600; color:var(--gray-600); }
        .sets-list { display:flex; flex-wrap:wrap; gap:0.5rem; }
        .set-tag { display:inline-flex; align-items:center; gap:0.35rem; padding:0.35rem 0.65rem; background:white; border:1px solid var(--gray-200); border-radius:4px; font-size:0.75rem; }
        .set-tag button { background:none; border:none; color:var(--gray-400); cursor:pointer; font-size:0.85rem; padding:0; margin-left:0.25rem; }
        .set-tag button:hover { color:var(--danger); }
        .add-set-row { display:flex; gap:0.5rem; margin-top:0.75rem; }
        .add-set-input { flex:1; padding:0.4rem 0.6rem; border:1px solid var(--gray-200); border-radius:4px; font-size:0.8rem; }
        .add-set-btn { padding:0.4rem 0.75rem; background:var(--accent); color:white; border:none; border-radius:4px; font-size:0.75rem; font-weight:500; cursor:pointer; }
        .add-set-btn:hover { background:var(--accent-dark); }
        
        /* Pixieset-style project layout */
        .project-layout-pixieset { display:flex; gap:0; min-height:calc(100vh - 140px); }
        .project-sidebar-pixieset { width:240px; flex-shrink:0; background:white; border-right:1px solid var(--gray-200); display:flex; flex-direction:column; }
        .project-sidebar-pixieset .project-cover-preview { aspect-ratio:16/10; border-radius:0; margin:0; }
        .project-sidebar-pixieset .sidebar-tabs { display:flex; border-bottom:1px solid var(--gray-200); padding:0; margin:0; }
        .project-sidebar-pixieset .sidebar-tab { flex:1; padding:0.75rem 0.5rem; font-size:1rem; border-bottom:2px solid transparent; }
        .project-sidebar-pixieset .sidebar-tab-content { padding:0; flex:1; overflow-y:auto; }
        .project-sidebar-pixieset .sidebar-section { padding:1rem; }
        
        /* Sets sidebar list (Pixieset style) */
        .sets-sidebar-header { display:flex; justify-content:space-between; align-items:center; padding:0.75rem 1rem; border-bottom:1px solid var(--gray-100); }
        .sets-sidebar-title { font-size:0.7rem; font-weight:600; color:var(--gray-400); letter-spacing:0.5px; }
        .add-set-link { font-size:0.8rem; color:var(--accent); cursor:pointer; background:none; border:none; font-weight:500; }
        .add-set-link:hover { color:var(--accent-dark); }
        
        .sets-sidebar-list { }
        .set-sidebar-item { display:flex; align-items:center; gap:0.5rem; padding:0.6rem 1rem; cursor:pointer; border-left:3px solid transparent; transition:all 0.15s; }
        .set-sidebar-item:hover { background:var(--gray-50); }
        .set-sidebar-item.active { background:var(--gray-50); border-left-color:var(--accent); }
        .set-sidebar-item-icon { width:16px; color:var(--gray-400); }
        .set-sidebar-item-name { flex:1; font-size:0.85rem; font-weight:500; color:var(--black); }
        .set-sidebar-item-count { font-size:0.75rem; color:var(--gray-400); }
        .set-sidebar-item-menu { opacity:0; background:none; border:none; color:var(--gray-400); cursor:pointer; padding:0.25rem; border-radius:4px; position:relative; }
        .set-sidebar-item:hover .set-sidebar-item-menu { opacity:1; }
        .set-sidebar-item-menu:hover { background:var(--gray-200); color:var(--gray-600); }
        
        .set-context-menu { position:absolute; top:0; left:100%; margin-left:4px; background:white; border:1px solid var(--gray-200); border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.15); min-width:120px; z-index:1000; padding:0.25rem 0; display:none; }
        .set-context-menu.show { display:block; }
        .set-context-menu-item { display:flex; align-items:center; gap:0.5rem; padding:0.6rem 0.875rem; font-size:0.85rem; color:var(--gray-600); cursor:pointer; white-space:nowrap; border:none; background:none; width:100%; text-align:left; }
        .set-context-menu-item:hover { background:var(--gray-50); color:var(--black); }
        .set-context-menu-item.danger { color:var(--danger); }
        .set-context-menu-item.danger:hover { background:#fef2f2; }
        
        /* Photos area (Pixieset style) */
        .project-photos-pixieset { flex:1; display:flex; flex-direction:column; background:var(--gray-50); }
        .photos-header-pixieset { display:flex; justify-content:space-between; align-items:center; padding:1rem 1.5rem; background:white; border-bottom:1px solid var(--gray-200); }
        .photos-header-pixieset h3 { font-size:1.25rem; font-weight:600; }
        
        #photosArea { flex:1; padding:1rem; overflow-y:auto; }
        
        .set-upload-zone { border:2px dashed var(--gray-300); border-radius:8px; margin-bottom:1rem; background:white; }
        .upload-zone-inner { padding:3rem; text-align:center; }
        .upload-zone-inner svg { margin:0 auto 1rem; color:var(--gray-400); }
        .upload-zone-inner h3 { font-size:1rem; font-weight:500; margin-bottom:0.5rem; color:var(--gray-600); }
        .upload-zone-inner p { font-size:0.85rem; color:var(--gray-500); }
        .upload-zone-inner a { color:var(--accent); text-decoration:none; }
        .upload-zone-inner a:hover { text-decoration:underline; }
        .set-upload-zone.dragover { border-color:var(--accent); background:var(--gray-50); }
        
        .upload-zone { border:2px dashed var(--gray-300); border-radius:12px; padding:3rem; text-align:center; cursor:pointer; transition:all 0.2s; background:white; }
        .upload-zone:hover, .upload-zone.dragover { border-color:var(--accent); background:#f0fdfa; }
        .upload-zone h3 { font-size:1.1rem; margin-bottom:0.5rem; }
        .upload-zone p { color:var(--gray-500); font-size:0.9rem; }
        .upload-zone input { display:none; }
        
        /* Preview Mode */
        .preview-mode-panel { display:none; background:var(--gray-900, #111); min-height:calc(100vh - 140px); }
        .preview-mode-panel.active { display:block; }
        .preview-mode-panel.active + .page-content { display:none; }
        
        .preview-toolbar { display:flex; justify-content:space-between; align-items:center; padding:1rem 1.5rem; background:white; border-bottom:1px solid var(--gray-200); position:sticky; top:65px; z-index:40; }
        .preview-toolbar-left { display:flex; align-items:center; gap:1.5rem; }
        .preview-title { color:var(--black); font-weight:600; font-size:0.95rem; }
        .preview-hint { color:var(--gray-500); font-size:0.8rem; }
        .preview-toolbar-right { display:flex; align-items:center; gap:0.75rem; }
        .preview-selected-count { color:var(--accent); font-weight:500; font-size:0.85rem; margin-right:0.5rem; }
        
        .preview-content { padding:2rem 1.5rem; background:white; min-height:calc(100vh - 130px); }
        .preview-header { margin-bottom:1.5rem; }
        .preview-header-date { font-size:0.9rem; font-weight:300; color:var(--gray-500); margin-bottom:0.5rem; }
        .preview-header-title { font-size:1.75rem; font-weight:400; margin-bottom:0.35rem; }
        .preview-header-venue { font-size:1rem; font-weight:300; color:var(--gray-500); margin-bottom:0.5rem; }
        .preview-header-credits { font-size:0.85rem; color:var(--gray-400); }
        
        .preview-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:6px; }
        .preview-photo { position:relative; cursor:pointer; overflow:hidden; background:var(--gray-100); }
        .preview-photo img { width:100%; height:auto; display:block; transition:transform 0.2s, opacity 0.2s; }
        .preview-photo:hover img { transform:scale(1.02); }
        .preview-photo.selected { outline:3px solid var(--accent); outline-offset:-3px; }
        .preview-photo.selected img { opacity:0.85; }
        .preview-photo.dragging { opacity:0.4; }
        .preview-photo.drag-over { outline:3px dashed var(--accent); outline-offset:-3px; }
        
        .preview-photo-number { position:absolute; top:8px; left:8px; background:rgba(0,0,0,0.6); color:white; font-size:0.7rem; font-weight:600; padding:0.2rem 0.5rem; border-radius:4px; }
        .preview-photo-check { position:absolute; top:8px; right:8px; width:24px; height:24px; border-radius:50%; background:rgba(0,0,0,0.4); border:2px solid rgba(255,255,255,0.8); display:flex; align-items:center; justify-content:center; opacity:0; transition:opacity 0.15s; }
        .preview-photo:hover .preview-photo-check, .preview-photo.selected .preview-photo-check { opacity:1; }
        .preview-photo.selected .preview-photo-check { background:var(--accent); border-color:var(--accent); }
        .preview-photo-check svg { width:14px; height:14px; color:white; display:none; }
        .preview-photo.selected .preview-photo-check svg { display:block; }
        
        .preview-photo-actions { position:absolute; bottom:8px; right:8px; display:flex; gap:4px; opacity:0; transition:opacity 0.15s; }
        .preview-photo:hover .preview-photo-actions { opacity:1; }
        .preview-photo-action { width:28px; height:28px; border-radius:4px; border:none; background:rgba(0,0,0,0.6); color:white; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:0.8rem; }
        .preview-photo-action:hover { background:rgba(0,0,0,0.8); }
        .preview-photo-action.delete:hover { background:var(--danger); }
        
        /* Upload Popup */
        .upload-popup { position:fixed; bottom:1.5rem; right:1.5rem; width:340px; background:white; border-radius:12px; box-shadow:0 4px 24px rgba(0,0,0,0.15); z-index:1000; display:none; overflow:hidden; }
        .upload-popup.show { display:block; }
        .upload-popup-header { display:flex; justify-content:space-between; align-items:center; padding:0.875rem 1rem; border-bottom:1px solid var(--gray-100); }
        .upload-popup-status { display:flex; align-items:center; gap:0.6rem; }
        .upload-popup-check { color:var(--success); display:none; }
        .upload-popup.completed .upload-popup-check { display:block; }
        .upload-popup-spinner { width:18px; height:18px; border:2px solid var(--gray-200); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
        .upload-popup.completed .upload-popup-spinner { display:none; }
        .upload-popup-title { font-weight:600; font-size:0.9rem; }
        .upload-popup-count { font-size:0.8rem; color:var(--gray-500); }
        .upload-popup-actions { display:flex; align-items:center; gap:0.25rem; }
        .upload-popup-toggle, .upload-popup-close { width:28px; height:28px; border:none; background:transparent; color:var(--gray-400); cursor:pointer; display:flex; align-items:center; justify-content:center; border-radius:4px; font-size:1.1rem; }
        .upload-popup-toggle:hover, .upload-popup-close:hover { background:var(--gray-100); color:var(--gray-600); }
        .upload-popup-toggle svg { transition:transform 0.2s; }
        .upload-popup.collapsed .upload-popup-toggle svg { transform:rotate(180deg); }
        .upload-popup-list { max-height:220px; overflow-y:auto; }
        .upload-popup.collapsed .upload-popup-list { display:none; }
        .upload-popup-item { display:flex; align-items:center; gap:0.6rem; padding:0.5rem 1rem; }
        .upload-popup-item-icon { width:32px; height:32px; background:var(--gray-100); border-radius:4px; display:flex; align-items:center; justify-content:center; flex-shrink:0; overflow:hidden; }
        .upload-popup-item-icon img { width:100%; height:100%; object-fit:cover; }
        .upload-popup-item-info { flex:1; min-width:0; }
        .upload-popup-item-name { font-size:0.8rem; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .upload-popup-item-meta { font-size:0.7rem; color:var(--gray-500); }
        .upload-popup-item-status { width:20px; flex-shrink:0; display:flex; align-items:center; justify-content:center; }
        .upload-popup-item-status svg { width:16px; height:16px; }
        .upload-popup-item-status.done { color:var(--success); }
        .upload-popup-item-status.error { color:var(--danger); }
        .upload-popup-item-status.uploading { width:14px; height:14px; border:2px solid var(--gray-200); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; }
        
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:1000; }
        .modal-overlay.show { display:flex; }
        .modal { background:white; border-radius:12px; padding:2rem; width:100%; max-width:500px; max-height:90vh; overflow-y:auto; }
        .modal h2 { font-size:1.25rem; margin-bottom:1.5rem; }
        .form-group { margin-bottom:1rem; }
        .form-group label { display:block; font-size:0.85rem; font-weight:500; margin-bottom:0.4rem; color:var(--gray-700); }
        .form-group input, .form-group textarea, .form-group select { width:100%; padding:0.6rem 0.75rem; border:1px solid var(--gray-200); border-radius:6px; font-size:0.9rem; font-family:inherit; }
        .form-group input:focus, .form-group textarea:focus { outline:none; border-color:var(--accent); }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
        .modal-actions { display:flex; gap:0.75rem; justify-content:flex-end; margin-top:1.5rem; padding-top:1rem; border-top:1px solid var(--gray-200); }
        
        .toast { position:fixed; bottom:2rem; left:50%; transform:translateX(-50%); background:var(--black); color:white; padding:0.875rem 1.5rem; border-radius:8px; font-size:0.9rem; font-weight:500; opacity:0; transition:all 0.3s; z-index:9999; }
        .toast.show { opacity:1; }
        .toast.success { background:var(--success); }
        .toast.error { background:var(--danger); }
        
        /* Upload Popup */
        .upload-popup {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            overflow: hidden;
        }
        .upload-popup.show { display: block; }
        .upload-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }
        .upload-popup-status {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .upload-popup-check {
            color: var(--success);
            display: none;
        }
        .upload-popup.completed .upload-popup-check { display: block; }
        .upload-popup-title { font-weight: 600; font-size: 0.9rem; }
        .upload-popup-count { font-size: 0.8rem; color: var(--gray-500); }
        .upload-popup-actions { display: flex; align-items: center; gap: 0.25rem; }
        .upload-popup-toggle, .upload-popup-close {
            width: 28px; height: 28px;
            border: none; background: transparent;
            color: var(--gray-500); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
        }
        .upload-popup-toggle:hover, .upload-popup-close:hover { background: var(--gray-100); }
        .upload-popup-close { font-size: 1.25rem; }
        .upload-popup-toggle svg { transition: transform 0.2s; }
        .upload-popup.collapsed .upload-popup-toggle svg { transform: rotate(180deg); }
        .upload-popup-list {
            max-height: 250px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .upload-popup.collapsed .upload-popup-list { display: none; }
        .upload-popup-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 6px;
        }
        .upload-popup-item:hover { background: var(--gray-50); }
        .upload-popup-item img {
            width: 36px; height: 36px;
            object-fit: cover;
            border-radius: 4px;
            background: var(--gray-200);
        }
        .upload-popup-item-info { flex: 1; min-width: 0; }
        .upload-popup-item-name {
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .upload-popup-item-size { font-size: 0.7rem; color: var(--gray-500); }
        .upload-popup-item-status {
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
        }
        .upload-popup-item-status.done { color: var(--success); }
        .upload-popup-item-status.error { color: var(--danger); }
        .upload-popup-item-status.uploading {
            width: 16px; height: 16px;
            border: 2px solid var(--gray-200);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .empty-state { text-align:center; padding:4rem 2rem; color:var(--gray-500); }
        .empty-state h3 { font-size:1.1rem; margin-bottom:0.5rem; color:var(--gray-700); }
        
        /* Settings */
        .settings-section { background:white; border-radius:8px; padding:1.5rem; margin-bottom:1.5rem; }
        .toggle-row { display:flex; justify-content:space-between; align-items:center; padding:1rem 0; border-bottom:1px solid var(--gray-100); }
        .toggle-row:last-child { border-bottom:none; }
        .toggle-info { flex:1; }
        .toggle-label { font-weight:500; font-size:0.9rem; margin-bottom:0.2rem; }
        .toggle-desc { font-size:0.8rem; color:var(--gray-500); }
        .toggle-switch { position:relative; width:48px; height:26px; flex-shrink:0; }
        .toggle-switch input { opacity:0; width:0; height:0; }
        .toggle-slider { position:absolute; cursor:pointer; inset:0; background:var(--gray-300); border-radius:26px; transition:0.3s; }
        .toggle-slider:before { position:absolute; content:""; height:20px; width:20px; left:3px; bottom:3px; background:white; border-radius:50%; transition:0.3s; }
        .toggle-switch input:checked + .toggle-slider { background:var(--accent); }
        .toggle-switch input:checked + .toggle-slider:before { transform:translateX(22px); }
        
        /* Small toggle for sidebar */
        .toggle-row-small { display:flex; justify-content:space-between; align-items:center; padding:0.5rem 0; font-size:0.85rem; }
        .toggle-switch-sm { position:relative; width:36px; height:20px; flex-shrink:0; }
        .toggle-switch-sm input { opacity:0; width:0; height:0; }
        .toggle-slider-sm { position:absolute; cursor:pointer; inset:0; background:var(--gray-300); border-radius:20px; transition:0.3s; }
        .toggle-slider-sm:before { position:absolute; content:""; height:14px; width:14px; left:3px; bottom:3px; background:white; border-radius:50%; transition:0.3s; }
        .toggle-switch-sm input:checked + .toggle-slider-sm { background:var(--accent); }
        .toggle-switch-sm input:checked + .toggle-slider-sm:before { transform:translateX(16px); }
        
        /* Project Tags */
        .tags-selector { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem; }
        .tag-option { padding:0.4rem 0.75rem; border:1px solid var(--gray-200); border-radius:20px; font-size:0.8rem; cursor:pointer; transition:all 0.2s; background:white; }
        .tag-option:hover { border-color:var(--accent); }
        .tag-option.selected { background:var(--accent); color:white; border-color:var(--accent); }
        
        .loading { text-align:center; padding:3rem; }
        .spinner { width:32px; height:32px; border:3px solid var(--gray-200); border-top-color:var(--accent); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 1rem; }
        @keyframes spin { to { transform:rotate(360deg); } }
        
        @media (max-width:768px) { .sidebar{display:none;} .main-content{margin-left:0;} .project-layout{flex-direction:column;} .project-sidebar{width:100%;} }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>Welcome Back</h1>
            <p>SF Event Photo Admin</p>
            <div class="login-error" id="loginError">Invalid password</div>
            <input type="password" id="passwordInput" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
            <button onclick="login()">Sign In</button>
        </div>
    </div>
    
    <div class="dashboard" id="dashboard">
        <aside class="sidebar">
            <div class="sidebar-header"><div class="logo">SF</div><span>SF Event Photo</span></div>
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="showCollections()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Collections</button>
                <button class="nav-item" onclick="showFeatured()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>Featured</button>
                <button class="nav-item" onclick="showUpload()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>Upload</button>
                <button class="nav-item" onclick="showOrders()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>Orders</button>
                <button class="nav-item" onclick="showLicenses()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Licenses</button>
                <button class="nav-item" onclick="showSettings()"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>Settings</button>
            </nav>
            <div class="sidebar-footer"><a href="/" target="_blank">View Site â†’</a><a href="#" onclick="logout()">Sign Out</a></div>
        </aside>
        
        <main class="main-content">
            <div class="tab-content active" id="collectionsTab">
                <header class="main-header"><h1>Collections</h1><div class="main-header-actions"><button class="btn btn-primary" onclick="openNewProjectModal()">+ New Collection</button></div></header>
                <div class="page-content"><div id="collectionsGrid" class="collections-grid"><div class="loading"><div class="spinner"></div></div></div></div>
            </div>
            
            <div class="tab-content" id="featuredTab">
                <header class="main-header">
                    <h1>Featured Projects</h1>
                    <div class="main-header-actions">
                        <button class="btn btn-secondary" onclick="openAddFeaturedModal()">+ Add to Featured</button>
                    </div>
                </header>
                <div class="page-content">
                    <p style="color:var(--gray-500);margin-bottom:1.5rem;font-size:0.9rem;">Drag to reorder. These projects appear in the "Featured Projects" section on the homepage.</p>
                    <div id="featuredGrid" class="collections-grid">
                        <div class="empty-state"><h3>No featured projects</h3><p>Add projects to feature them on the homepage</p></div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="projectTab">
                <header class="main-header">
                    <div class="project-header">
                        <button class="back-btn" onclick="showCollections()"><svg width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <div class="project-header-info"><h2 id="projectTitle">Project</h2><p id="projectMeta">0 photos</p></div>
                    </div>
                    <div class="main-header-actions">
                        <button class="btn btn-secondary" onclick="togglePreviewMode()" id="previewModeBtn">ðŸ‘ Preview</button>
                        <button class="btn btn-secondary" onclick="openEditProjectModal()">Edit</button>
                        <button class="btn btn-primary" id="publishBtn" onclick="togglePublishCurrent()">Publish</button>
                    </div>
                </header>
                
                <!-- Preview Mode Panel -->
                <div class="preview-mode-panel" id="previewModePanel">
                    <div class="preview-toolbar">
                        <div class="preview-toolbar-left">
                            <span class="preview-title">Preview Mode</span>
                            <span class="preview-hint">Click photos to select â€¢ Drag to reorder â€¢ Press Delete to remove</span>
                        </div>
                        <div class="preview-toolbar-right">
                            <span class="preview-selected-count" id="previewSelectedCount">0 selected</span>
                            <button class="btn btn-sm btn-secondary" onclick="selectAllPreview()">Select All</button>
                            <button class="btn btn-sm btn-secondary" onclick="deselectAllPreview()">Deselect</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSelectedPreview()" id="previewDeleteBtn" disabled>Delete Selected</button>
                            <button class="btn btn-sm btn-primary" onclick="togglePreviewMode()">Exit Preview</button>
                        </div>
                    </div>
                    <div class="preview-content">
                        <div class="preview-header" id="previewHeader">
                            <!-- Will be populated dynamically -->
                        </div>
                        <div class="preview-grid" id="previewGrid">
                            <!-- Preview photos will be rendered here -->
                        </div>
                    </div>
                </div>
                
                <div class="page-content" id="projectEditContent">
                    <div class="project-layout-pixieset">
                        <div class="project-sidebar-pixieset">
                            <div class="project-cover-preview">
                                <img id="projectCover" src="" alt="">
                            </div>
                            
                            <div class="sidebar-tabs">
                                <button class="sidebar-tab active" onclick="switchSidebarTab('photos')">ðŸ“·</button>
                                <button class="sidebar-tab" onclick="switchSidebarTab('settings')">âš™ï¸</button>
                                <button class="sidebar-tab" onclick="switchSidebarTab('seo')">ðŸ”</button>
                                <button class="sidebar-tab" onclick="switchSidebarTab('activity')">ðŸ“Š</button>
                            </div>
                            
                            <div class="sidebar-tab-content active" id="photosTab">
                                <div class="sets-sidebar-header">
                                    <span class="sets-sidebar-title">PHOTOS</span>
                                    <button class="add-set-link" onclick="openNewSetModal()">âŠ• Add Set</button>
                                </div>
                                <div class="sets-sidebar-list" id="setsSidebarList">
                                    <!-- Sets will be rendered here -->
                                </div>
                            </div>
                            
                            <div class="sidebar-tab-content" id="settingsTab">
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Homepage Display</div>
                                    <div class="toggle-row-small">
                                        <span>â­ Featured Project</span>
                                        <label class="toggle-switch-sm">
                                            <input type="checkbox" id="projectFeaturedToggle" onchange="saveProjectToggles()">
                                            <span class="toggle-slider-sm"></span>
                                        </label>
                                    </div>
                                    <p style="font-size:0.7rem;color:var(--gray-400);margin-top:0.25rem;">Featured projects appear at the top of the homepage</p>
                                </div>
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Project Features</div>
                                    <div class="toggle-row-small">
                                        <span>Enable Cart</span>
                                        <label class="toggle-switch-sm">
                                            <input type="checkbox" id="projectCartToggle" onchange="saveProjectToggles()">
                                            <span class="toggle-slider-sm"></span>
                                        </label>
                                    </div>
                                    <div class="toggle-row-small">
                                        <span>Enable Downloads</span>
                                        <label class="toggle-switch-sm">
                                            <input type="checkbox" id="projectDownloadsToggle" onchange="saveProjectToggles()">
                                            <span class="toggle-slider-sm"></span>
                                        </label>
                                    </div>
                                </div>
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Download Code</div>
                                    <input type="text" class="sidebar-input" id="projectCode" placeholder="XXXX-XXXX" style="text-transform:uppercase;">
                                    <button class="btn btn-sm btn-secondary" onclick="saveProjectCode()" style="width:100%;">Save Code</button>
                                </div>
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Allowed Email Domains</div>
                                    <div class="domains-list" id="projectDomains"></div>
                                    <div class="add-domain-row">
                                        <input type="text" id="newDomainInput" placeholder="@company.com" onkeypress="if(event.key==='Enter')addDomain()">
                                        <button onclick="addDomain()">Add</button>
                                    </div>
                                </div>
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Brands</div>
                                    <input type="text" class="sidebar-input" id="projectBrands" placeholder="Nike, Apple">
                                    <button class="btn btn-sm btn-secondary" onclick="saveProjectBrands()" style="width:100%;">Save Brands</button>
                                </div>
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Videos (Vimeo)</div>
                                    <div class="video-list" id="projectVideos"></div>
                                    <div class="add-video-row">
                                        <input type="text" id="newVideoInput" placeholder="Vimeo URL or ID" onkeypress="if(event.key==='Enter')addVideo()">
                                        <button onclick="addVideo()">Add</button>
                                    </div>
                                    <p style="font-size:0.7rem;color:var(--gray-400);margin-top:0.5rem;">Paste Vimeo URL (e.g., vimeo.com/123456789)</p>
                                </div>
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Available Licenses</div>
                                    <p style="font-size:0.7rem;color:var(--gray-400);margin-bottom:0.5rem;">Select which licenses are available for this project</p>
                                    <div class="project-licenses-list" id="projectLicensesList"></div>
                                    <button class="btn btn-sm btn-secondary" onclick="saveProjectLicenses()" style="width:100%;margin-top:0.5rem;">Save Licenses</button>
                                </div>
                            </div>
                            
                            <div class="sidebar-tab-content" id="activityTab">
                                <div class="activity-list" id="activityList">
                                    <div class="loading"><div class="spinner"></div></div>
                                </div>
                            </div>
                            
                            <div class="sidebar-tab-content" id="seoTab">
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Meta Title</div>
                                    <input type="text" class="sidebar-input" id="seoTitle" placeholder="Event Name | SF Event Photo" maxlength="60">
                                    <div class="seo-hint">50-60 characters recommended. <span id="seoTitleCount">0</span>/60</div>
                                </div>
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Meta Description</div>
                                    <textarea class="sidebar-input" id="seoDescription" placeholder="Professional photos from [Event Name]. Download high-resolution images..." rows="3" maxlength="160" style="resize:none;"></textarea>
                                    <div class="seo-hint">150-160 characters recommended. <span id="seoDescCount">0</span>/160</div>
                                </div>
                                <div class="sidebar-section">
                                    <div class="sidebar-section-title">Keywords</div>
                                    <input type="text" class="sidebar-input" id="seoKeywords" placeholder="event photos, san francisco, corporate event">
                                    <div class="seo-hint">Comma-separated. Include: event name, location, brands, type</div>
                                </div>
                                <button class="btn btn-sm btn-secondary" onclick="generateSeoSuggestions()" style="width:100%;margin-bottom:0.75rem;">âœ¨ Auto-Generate</button>
                                <button class="btn btn-sm btn-primary" onclick="saveSeoData()" style="width:100%;">Save SEO Data</button>
                                
                                <div class="seo-preview-section">
                                    <div class="sidebar-section-title" style="margin-top:1.25rem;">Google Preview</div>
                                    <div class="seo-google-preview">
                                        <div class="seo-preview-title" id="previewTitle">Page Title</div>
                                        <div class="seo-preview-url" id="previewUrl">sfeventphoto.com/project/...</div>
                                        <div class="seo-preview-desc" id="previewDesc">Meta description will appear here...</div>
                                    </div>
                                </div>
                                
                                <div class="seo-schema-section">
                                    <div class="sidebar-section-title" style="margin-top:1.25rem;">Schema Markup (JSON-LD)</div>
                                    <div class="seo-hint" style="margin-bottom:0.5rem;">Auto-generated structured data for search engines & AI</div>
                                    <textarea class="sidebar-input seo-schema-code" id="seoSchema" rows="6" readonly style="font-family:monospace;font-size:0.7rem;resize:none;background:var(--gray-50);"></textarea>
                                    <button class="btn btn-sm btn-secondary" onclick="copySchema()" style="width:100%;margin-top:0.5rem;">ðŸ“‹ Copy Schema</button>
                                </div>
                                
                                <div class="seo-tips">
                                    <div class="sidebar-section-title" style="margin-top:1.25rem;">ðŸ’¡ SEO Best Practices</div>
                                    <ul class="seo-tips-list">
                                        <li><strong>Title:</strong> Include event name + location + "photos"</li>
                                        <li><strong>Description:</strong> Mention key brands, date, what viewers will find</li>
                                        <li><strong>Keywords:</strong> Event name, venue, brands, "event photography"</li>
                                        <li><strong>Images:</strong> Add alt text (people tags help!)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="project-photos-pixieset">
                            <div class="photos-header-pixieset">
                                <h3 id="currentSetTitle">All Photos</h3>
                                <div style="display:flex;gap:0.5rem;align-items:center;">
                                    <button class="btn btn-sm btn-secondary" onclick="toggleSelectAll()" id="selectAllBtn">â˜ Select All</button>
                                    <button class="btn btn-sm btn-primary" onclick="triggerSetUpload()">âŠ• Add Media</button>
                                    <button class="btn btn-sm btn-secondary" onclick="saveAllTags()">Save All Tags</button>
                                </div>
                            </div>
                            <div class="bulk-action-bar" id="bulkActionBar">
                                <span class="bulk-count" id="bulkCount">0 selected</span>
                                <button onclick="bulkMoveToFront()">â†‘ Move to Front</button>
                                <button onclick="bulkMoveToBack()">â†“ Move to Back</button>
                                <select id="bulkMoveSelect" onchange="bulkMoveToSet(this.value); this.value='';">
                                    <option value="">Move to set...</option>
                                    <option value="__none__">No set</option>
                                </select>
                                <button onclick="bulkDeselectAll()">Deselect</button>
                                <button class="danger" onclick="bulkDelete()">ðŸ—‘ Delete</button>
                            </div>
                            <div id="photosArea">
                                <div id="setUploadZone" class="set-upload-zone" style="display:none;">
                                    <div class="upload-zone-inner">
                                        <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                                        <h3>Drag photos and videos here to upload</h3>
                                        <p>or <a href="#" onclick="document.getElementById('setFileInput').click(); return false;">Browse files</a></p>
                                        <input type="file" id="setFileInput" multiple accept="image/jpeg,image/png,image/webp" style="display:none;">
                                    </div>
                                </div>
                                <div id="photosGrid" class="photos-grid"><div class="loading"><div class="spinner"></div></div></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="uploadTab">
                <header class="main-header"><h1>Upload Photos</h1></header>
                <div class="page-content">
                    <div class="form-group" style="max-width:400px;margin-bottom:1.5rem;">
                        <label>Select Collection</label>
                        <select id="uploadProjectSelect" class="sidebar-input"><option value="">Choose...</option></select>
                    </div>
                    <div class="upload-zone" id="uploadZone">
                        <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin:0 auto 1rem;color:var(--gray-400);"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                        <h3>Drag & drop photos here</h3>
                        <p>or click to browse â€¢ JPG, PNG, WebP</p>
                        <input type="file" id="fileInput" multiple accept="image/jpeg,image/png,image/webp">
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="ordersTab">
                <header class="main-header"><h1>Orders</h1></header>
                <div class="page-content"><div id="ordersList"><div class="loading"><div class="spinner"></div></div></div></div>
            </div>
            
            <div class="tab-content" id="licensesTab">
                <header class="main-header"><h1>Licenses</h1></header>
                <div class="page-content">
                    <div style="max-width:700px;">
                        <p style="font-size:0.9rem;color:var(--gray-500);margin-bottom:1.5rem;">Define the license types available for purchase. By default, all licenses are enabled for every project. You can disable specific licenses at the project level in the project settings.</p>
                        
                        <div id="licensesList" class="licenses-list"></div>
                        
                        <div class="add-license-form" id="addLicenseForm" style="display:none;">
                            <h4 style="margin-bottom:1rem;font-size:0.95rem;">Add New License</h4>
                            <div class="form-group" style="margin-bottom:0.75rem;">
                                <label style="font-size:0.8rem;margin-bottom:0.25rem;display:block;">License Name</label>
                                <input type="text" id="newLicenseName" placeholder="e.g., Print Usage" class="sidebar-input">
                            </div>
                            <div class="form-group" style="margin-bottom:0.75rem;">
                                <label style="font-size:0.8rem;margin-bottom:0.25rem;display:block;">Price (USD)</label>
                                <input type="number" id="newLicensePrice" placeholder="e.g., 150" class="sidebar-input">
                            </div>
                            <div class="form-group" style="margin-bottom:0.75rem;">
                                <label style="font-size:0.8rem;margin-bottom:0.25rem;display:block;">Description (one item per line)</label>
                                <textarea id="newLicenseDesc" placeholder="High-resolution digital file&#10;Unlimited usage&#10;No expiration" class="sidebar-input" rows="4" style="resize:none;"></textarea>
                            </div>
                            <div style="display:flex;gap:0.5rem;">
                                <button type="button" class="btn btn-primary" onclick="saveLicense()">Save License</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelAddLicense()">Cancel</button>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" id="addLicenseBtn" onclick="showAddLicenseForm()" style="margin-top:1rem;">+ Add License Type</button>
                        
                        <div id="licensesStatus" style="margin-top:1rem;font-size:0.85rem;color:var(--success);"></div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="settingsTabContent">
                <header class="main-header"><h1>Settings</h1></header>
                <div class="page-content">
                    <div style="max-width:500px;">
                        <div class="settings-section">
                            <h3 style="font-size:1rem;font-weight:600;margin-bottom:1rem;">Site Features</h3>
                            <div class="toggle-row">
                                <div class="toggle-info">
                                    <div class="toggle-label">Enable Cart</div>
                                    <div class="toggle-desc">Allow users to add photos to cart and purchase</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleCart" onchange="saveSiteSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <div class="toggle-row">
                                <div class="toggle-info">
                                    <div class="toggle-label">Enable Downloads</div>
                                    <div class="toggle-desc">Allow users to download photos (requires email or code)</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="toggleDownloads" onchange="saveSiteSettings()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        
                        <div id="settingsStatus" style="margin-top:1rem;font-size:0.85rem;color:var(--success);"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="modal-overlay" id="newProjectModal">
        <div class="modal" style="max-width:560px;">
            <div class="modal-steps">
                <div class="modal-step active" data-step="1"><span class="step-num">1</span> Details</div>
                <div class="modal-step" data-step="2"><span class="step-num">2</span> SEO & Discoverability</div>
            </div>
            
            <form onsubmit="createProject(event)">
                <!-- Step 1: Basic Details -->
                <div class="step-content active" id="newStep1">
                    <h2 style="margin-bottom:1.5rem;">Collection Details</h2>
                    <div class="form-group"><label>Title *</label><input type="text" id="newTitle" required placeholder="Company Event 2026" oninput="updateNewSeoPreview()"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Start Date</label><input type="date" id="newDate" onchange="updateNewSeoPreview()"></div>
                        <div class="form-group"><label>End Date (optional)</label><input type="date" id="newEndDate"></div>
                    </div>
                    <div class="form-group"><label>Venue / Location</label><input type="text" id="newVenue" placeholder="The Ritz-Carlton, San Francisco" oninput="updateNewSeoPreview()"></div>
                    <div class="form-group"><label>Client / Brands</label><input type="text" id="newBrands" placeholder="Acme Corp, Nike (comma-separated)" oninput="updateNewSeoPreview()"></div>
                    <div class="form-group"><label>Tags</label>
                        <div class="tags-selector" id="newTagsSelector">
                            <span class="tag-option" data-tag="Activation" onclick="toggleTag(this)">Activation</span>
                            <span class="tag-option" data-tag="Conference" onclick="toggleTag(this)">Conference</span>
                            <span class="tag-option" data-tag="Corporate" onclick="toggleTag(this)">Corporate</span>
                            <span class="tag-option" data-tag="Party" onclick="toggleTag(this)">Party</span>
                            <span class="tag-option" data-tag="Portraits" onclick="toggleTag(this)">Portraits</span>
                            <span class="tag-option" data-tag="PR" onclick="toggleTag(this)">PR</span>
                            <span class="tag-option" data-tag="University" onclick="toggleTag(this)">University</span>
                            <span class="tag-option" data-tag="Video" onclick="toggleTag(this)">Video</span>
                        </div>
                    </div>
                    <div class="form-group"><label>Download Code</label><div style="display:flex;gap:0.5rem;"><input type="text" id="newCode" placeholder="XXXX-XXXX" style="text-transform:uppercase;"><button type="button" class="btn btn-secondary" onclick="generateCode('newCode')">Generate</button></div></div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('newProjectModal')">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="goToStep(2)">Next: SEO â†’</button>
                    </div>
                </div>
                
                <!-- Step 2: SEO -->
                <div class="step-content" id="newStep2">
                    <h2 style="margin-bottom:0.5rem;">SEO & Discoverability</h2>
                    <p style="color:var(--gray-500);font-size:0.85rem;margin-bottom:1.25rem;">Help search engines and AI assistants find and recommend this project.</p>
                    
                    <div class="seo-best-practices-box">
                        <div class="seo-bp-title">ðŸ’¡ Best Practices for Event Photography SEO</div>
                        <ul class="seo-bp-list">
                            <li><strong>Title:</strong> Include client name + event type + city. Example: "Salesforce Dreamforce Conference Photos | San Francisco"</li>
                            <li><strong>Description:</strong> Always include "SF Event Photo". Mention the client, event type, date, venue, and what's in the gallery. Keep it natural, not keyword-stuffed.</li>
                            <li><strong>Keywords:</strong> Include variations: "corporate event photography", "conference photos", client name, venue name, city.</li>
                            <li><strong>For AI/LLMs:</strong> Be specific and factual. AI assistants look for clear statements like "SF Event Photo captured [Event] at [Venue]". Avoid calls to action like "browse and download".</li>
                        </ul>
                    </div>
                    
                    <div class="form-group">
                        <label>Meta Title <span class="char-count">(<span id="newSeoTitleCount">0</span>/60)</span></label>
                        <input type="text" id="newSeoTitle" placeholder="Client Event Photos | San Francisco | SF Event Photo" maxlength="60" oninput="document.getElementById('newSeoTitleCount').textContent=this.value.length">
                        <div class="field-hint">What appears in Google search results and browser tabs</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Meta Description <span class="char-count">(<span id="newSeoDescCount">0</span>/160)</span></label>
                        <textarea id="newSeoDesc" placeholder="SF Event Photo captured [Event Name] at [Venue], [Month Year]. Professional corporate event photography coverage." rows="3" maxlength="160" oninput="document.getElementById('newSeoDescCount').textContent=this.value.length" style="resize:none;"></textarea>
                        <div class="field-hint">The snippet shown below your title in search results</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Keywords</label>
                        <input type="text" id="newSeoKeywords" placeholder="corporate event photography, san francisco, conference photos, [client name]">
                        <div class="field-hint">Comma-separated. Include: client name, event type, city, "event photography"</div>
                    </div>
                    
                    <button type="button" class="btn btn-secondary" onclick="autoGenerateNewSeo()" style="width:100%;margin-bottom:1rem;">âœ¨ Auto-Generate from Details</button>
                    
                    <div class="seo-preview-box">
                        <div class="seo-preview-label">Google Preview</div>
                        <div class="seo-preview-title" id="newPreviewTitle">Page Title</div>
                        <div class="seo-preview-url" id="newPreviewUrl">sfeventphoto.com/project/...</div>
                        <div class="seo-preview-desc" id="newPreviewDesc">Your meta description will appear here...</div>
                    </div>
                    
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">â† Back</button>
                        <button type="button" class="btn btn-secondary" onclick="createProject(event)" style="margin-left:auto;">Skip SEO</button>
                        <button type="submit" class="btn btn-primary">Create Collection</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay" id="editProjectModal">
        <div class="modal">
            <h2>Edit Collection</h2>
            <div class="form-group"><label>Title</label><input type="text" id="editTitle"></div>
            <div class="form-row">
                <div class="form-group"><label>Start Date</label><input type="date" id="editDate"></div>
                <div class="form-group"><label>End Date (optional)</label><input type="date" id="editEndDate"></div>
            </div>
            <div class="form-group"><label>Venue</label><input type="text" id="editVenue"></div>
            <div class="form-group"><label>Tags</label>
                <div class="tags-selector" id="editTagsSelector">
                    <span class="tag-option" data-tag="Activation" onclick="toggleTag(this)">Activation</span>
                    <span class="tag-option" data-tag="Conference" onclick="toggleTag(this)">Conference</span>
                    <span class="tag-option" data-tag="Corporate" onclick="toggleTag(this)">Corporate</span>
                    <span class="tag-option" data-tag="Party" onclick="toggleTag(this)">Party</span>
                    <span class="tag-option" data-tag="Portraits" onclick="toggleTag(this)">Portraits</span>
                    <span class="tag-option" data-tag="PR" onclick="toggleTag(this)">PR</span>
                    <span class="tag-option" data-tag="University" onclick="toggleTag(this)">University</span>
                    <span class="tag-option" data-tag="Video" onclick="toggleTag(this)">Video</span>
                </div>
            </div>
            
            <!-- SEO Fields -->
            <div style="border-top:1px solid var(--gray-200);margin-top:1.25rem;padding-top:1.25rem;">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:1rem;color:var(--gray-700);">ðŸ” SEO Settings</div>
                <div class="form-group">
                    <label>SEO Title</label>
                    <input type="text" id="editSeoTitle" placeholder="Event Name | SF Event Photo" maxlength="60">
                    <div class="seo-hint">50-60 characters recommended. <span id="editSeoTitleCount">0</span>/60</div>
                </div>
                <div class="form-group">
                    <label>SEO Description</label>
                    <textarea id="editSeoDescription" placeholder="Professional photos from [Event Name]. Download high-resolution images..." rows="3" maxlength="160"></textarea>
                    <div class="seo-hint">150-160 characters recommended. <span id="editSeoDescCount">0</span>/160</div>
                </div>
                <div class="form-group">
                    <label>SEO Keywords</label>
                    <input type="text" id="editSeoKeywords" placeholder="event photos, san francisco, corporate event">
                    <div class="seo-hint">Comma-separated</div>
                </div>
            </div>
            
            <div class="form-group" style="padding:1rem;background:var(--gray-50);border-radius:8px;margin-top:1rem;">
                <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                    <label class="toggle-switch" style="margin:0;">
                        <input type="checkbox" id="editPrivate" onchange="togglePasswordField()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span style="font-weight:500;">Private Gallery</span>
                </div>
                <div id="passwordFieldWrapper" style="display:none;">
                    <label style="font-size:0.8rem;color:var(--gray-500);margin-bottom:0.25rem;display:block;">Gallery Password</label>
                    <input type="text" id="editPassword" placeholder="Enter password for this gallery" style="width:100%;">
                    <div style="font-size:0.75rem;color:var(--gray-400);margin-top:0.25rem;">Visitors will need this password to view photos</div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="deleteCurrentProject()" style="margin-right:auto;">Delete</button>
                <button class="btn btn-secondary" onclick="duplicateCurrentProject()">Duplicate</button>
                <button class="btn btn-secondary" onclick="closeModal('editProjectModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveEditProject()">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Add to Featured Modal -->
    <div class="modal-overlay" id="addFeaturedModal">
        <div class="modal" style="max-width:500px;">
            <h2 style="margin-bottom:0.5rem;">Add to Featured</h2>
            <p style="color:var(--gray-500);font-size:0.85rem;margin-bottom:1.5rem;">Select a project to feature on the homepage.</p>
            <div id="availableProjectsList" style="max-height:400px;overflow-y:auto;margin-bottom:1.5rem;">
                <div class="loading"><div class="spinner"></div></div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('addFeaturedModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Upload Status Popup -->
    <div class="upload-popup" id="uploadPopup">
        <div class="upload-popup-header">
            <div class="upload-popup-status">
                <div class="upload-popup-spinner"></div>
                <svg class="upload-popup-check" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M20 6L9 17l-5-5"/></svg>
                <div>
                    <div class="upload-popup-title" id="uploadTitle">Uploading...</div>
                    <div class="upload-popup-count" id="uploadCount">0 items</div>
                </div>
            </div>
            <div class="upload-popup-actions">
                <button class="upload-popup-toggle" onclick="toggleUploadPopup()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg></button>
                <button class="upload-popup-close" onclick="closeUploadPopup()">Ã—</button>
            </div>
        </div>
        <div class="upload-popup-list" id="uploadList"></div>
    </div>
    
    <!-- New Set Modal -->
    <div class="modal-overlay" id="newSetModal">
        <div class="modal" style="max-width:420px;">
            <h2>NEW PHOTO SET</h2>
            <div class="form-group">
                <label>Photo Set Name</label>
                <input type="text" id="newSetName" placeholder="e.g. Ceremony, Reception, Getting ready">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="newSetDescription" rows="3" placeholder="Optional" maxlength="500" style="resize:none;" oninput="document.getElementById('setDescCount').textContent=this.value.length"></textarea>
                <div class="field-hint"><span id="setDescCount">0</span> / 500</div>
                <div class="field-hint">Description is shown to clients viewing this photo set for additional storytelling.</div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('newSetModal')">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createNewSet()">Save</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
    const API_URL='https://sf-event-photo-backend.vercel.app';
    const ADMIN_PASSWORD='sfeventphoto2024';
    let projects=[],currentProject=null,currentPhotos=[];
    let nextPhotoSeq = 142763; // Start at 142763 so first photo is 142764
    
    // Generate XXXXXX filename from a sequential counter
    async function getNextPhotoFilename(ext) {
        // On first call, fetch highest existing ID from current project's photos
        if (nextPhotoSeq === 142763 && currentPhotos.length > 0) {
            currentPhotos.forEach(p => {
                const m = (p.filename || '').match(/^(\d+)/);
                if (m) nextPhotoSeq = Math.max(nextPhotoSeq, parseInt(m[1]));
            });
        }
        nextPhotoSeq++;
        const id = String(nextPhotoSeq).padStart(6, '0');
        return `${id}${ext}`;
    }
    
    if(sessionStorage.getItem('adminLoggedIn'))showDashboard();
    
    function login(){if(document.getElementById('passwordInput').value===ADMIN_PASSWORD){sessionStorage.setItem('adminLoggedIn','true');showDashboard();}else{document.getElementById('loginError').style.display='block';}}
    function logout(){sessionStorage.removeItem('adminLoggedIn');location.reload();}
    function showDashboard(){document.getElementById('loginScreen').style.display='none';document.getElementById('dashboard').classList.add('active');loadProjects();setupUpload();}
    
    function setActiveNav(idx){document.querySelectorAll('.nav-item').forEach((n,i)=>n.classList.toggle('active',i===idx));}
    function showCollections(){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('collectionsTab').classList.add('active');setActiveNav(0);}
    function showFeatured(){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('featuredTab').classList.add('active');setActiveNav(1);renderFeatured();}
    function showUpload(){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('uploadTab').classList.add('active');setActiveNav(2);updateDropdown();}
    function showOrders(){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('ordersTab').classList.add('active');setActiveNav(3);loadOrders();}
    function showLicenses(){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('licensesTab').classList.add('active');setActiveNav(4);loadLicenses();}
    function showSettings(){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('settingsTabContent').classList.add('active');setActiveNav(5);loadSiteSettings();}
    
    // Site settings
    let siteSettings = { cart_enabled: true, downloads_enabled: true, licenses: [] };
    
    // Default licenses
    const DEFAULT_LICENSES = [
        { id: 'web_editorial', name: 'Web Editorial (Single Use)', price: 8500, description: 'High-resolution digital file\nSingle use on website or social media\nNo expiration date' },
        { id: 'pr_usage', name: 'PR / Commercial Usage', price: 25000, description: 'High-resolution digital file\nUnlimited digital & print usage\nPR, advertising, and commercial use\nNo expiration date' }
    ];
    
    async function loadLicenses() {
        try {
            const r = await fetch(`${API_URL}/api/site-settings`);
            const data = await r.json();
            siteSettings = data.settings || { cart_enabled: true, downloads_enabled: true, licenses: [] };
            
            // Initialize with default licenses if none exist
            if (!siteSettings.licenses || siteSettings.licenses.length === 0) {
                siteSettings.licenses = DEFAULT_LICENSES;
            }
            
            renderLicensesList();
        } catch (e) {
            console.log('Could not load licenses, using defaults');
            siteSettings.licenses = DEFAULT_LICENSES;
            renderLicensesList();
        }
    }
    
    async function loadSiteSettings() {
        try {
            const r = await fetch(`${API_URL}/api/site-settings`);
            const data = await r.json();
            siteSettings = data.settings || { cart_enabled: true, downloads_enabled: true, licenses: [] };
            
            // Initialize with default licenses if none exist
            if (!siteSettings.licenses || siteSettings.licenses.length === 0) {
                siteSettings.licenses = DEFAULT_LICENSES;
            }
            
            document.getElementById('toggleCart').checked = siteSettings.cart_enabled !== false;
            document.getElementById('toggleDownloads').checked = siteSettings.downloads_enabled !== false;
        } catch (e) {
            console.log('Could not load settings, using defaults');
        }
    }
    
    async function saveSiteSettings() {
        const settings = {
            cart_enabled: document.getElementById('toggleCart').checked,
            downloads_enabled: document.getElementById('toggleDownloads').checked,
            licenses: siteSettings.licenses || []
        };
        try {
            await fetch(`${API_URL}/api/site-settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify(settings)
            });
            document.getElementById('settingsStatus').textContent = 'âœ“ Settings saved';
            setTimeout(() => document.getElementById('settingsStatus').textContent = '', 2000);
        } catch (e) {
            showToast('Error saving settings', 'error');
        }
    }
    
    // License management
    function renderLicensesList() {
        const container = document.getElementById('licensesList');
        const licenses = siteSettings.licenses || [];
        
        if (licenses.length === 0) {
            container.innerHTML = '<div class="empty-state" style="padding:2rem;text-align:center;"><p style="color:var(--gray-400);">No licenses defined yet. Add your first license type below.</p></div>';
            return;
        }
        
        container.innerHTML = licenses.map((lic, idx) => `
            <div class="license-item">
                <div class="license-item-info">
                    <div class="license-item-name">${lic.name}</div>
                    <div class="license-item-price">$${(lic.price / 100).toFixed(2)}</div>
                    <div class="license-item-desc">${(lic.description || '').split('\n').map(line => `â€¢ ${line}`).join('<br>')}</div>
                </div>
                <div class="license-item-actions">
                    <button onclick="editLicense(${idx})" title="Edit">âœï¸</button>
                    <button class="delete" onclick="deleteLicense(${idx})" title="Delete">ðŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    }
    
    function showAddLicenseForm() {
        document.getElementById('addLicenseForm').style.display = 'block';
        document.getElementById('addLicenseBtn').style.display = 'none';
        document.getElementById('newLicenseName').value = '';
        document.getElementById('newLicensePrice').value = '';
        document.getElementById('newLicenseDesc').value = '';
        document.getElementById('addLicenseForm').dataset.editIndex = '';
    }
    
    function cancelAddLicense() {
        document.getElementById('addLicenseForm').style.display = 'none';
        document.getElementById('addLicenseBtn').style.display = 'block';
    }
    
    function editLicense(idx) {
        const lic = siteSettings.licenses[idx];
        document.getElementById('addLicenseForm').style.display = 'block';
        document.getElementById('addLicenseBtn').style.display = 'none';
        document.getElementById('newLicenseName').value = lic.name;
        document.getElementById('newLicensePrice').value = (lic.price / 100).toFixed(0);
        document.getElementById('newLicenseDesc').value = lic.description || '';
        document.getElementById('addLicenseForm').dataset.editIndex = idx;
    }
    
    async function saveLicense() {
        const name = document.getElementById('newLicenseName').value.trim();
        const priceStr = document.getElementById('newLicensePrice').value.trim();
        const desc = document.getElementById('newLicenseDesc').value.trim();
        
        if (!name || !priceStr) {
            showToast('Please enter name and price', 'error');
            return;
        }
        
        const price = Math.round(parseFloat(priceStr) * 100); // Convert to cents
        const id = name.toLowerCase().replace(/[^a-z0-9]+/g, '_');
        
        const editIndex = document.getElementById('addLicenseForm').dataset.editIndex;
        
        if (editIndex !== '' && editIndex !== undefined) {
            // Editing existing
            siteSettings.licenses[parseInt(editIndex)] = { id, name, price, description: desc };
        } else {
            // Adding new
            siteSettings.licenses.push({ id, name, price, description: desc });
        }
        
        await saveSiteSettings();
        renderLicensesList();
        cancelAddLicense();
        showToast('License saved!', 'success');
    }
    
    async function deleteLicense(idx) {
        if (!confirm('Delete this license type?')) return;
        siteSettings.licenses.splice(idx, 1);
        await saveSiteSettings();
        renderLicensesList();
        showToast('License deleted', 'success');
    }
    
    // Project tags
    function toggleTag(el) {
        el.classList.toggle('selected');
    }
    
    function getSelectedTags(selectorId) {
        const tags = [];
        document.querySelectorAll(`#${selectorId} .tag-option.selected`).forEach(el => {
            tags.push(el.dataset.tag);
        });
        return tags;
    }
    
    function setSelectedTags(selectorId, tags) {
        document.querySelectorAll(`#${selectorId} .tag-option`).forEach(el => {
            el.classList.remove('selected');
            if (tags && tags.includes(el.dataset.tag)) {
                el.classList.add('selected');
            }
        });
    }
    
    async function showProject(id){
        currentProject=projects.find(p=>p.id===id);if(!currentProject)return;
        document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
        document.getElementById('projectTab').classList.add('active');setActiveNav(-1);
        document.getElementById('projectTitle').textContent=currentProject.title;
        document.getElementById('projectMeta').textContent=`${formatDateRange(currentProject.event_date, currentProject.event_end_date)} â€¢ ${currentProject.photo_count||0} photos`;
        document.getElementById('projectCover').src=currentProject.cover_image_url||'';
        document.getElementById('projectCode').value=currentProject.download_code||'';
        document.getElementById('projectBrands').value=(currentProject.brands||[]).join(', ');
        document.getElementById('publishBtn').textContent=currentProject.published?'Unpublish':'Publish';
        document.getElementById('projectCartToggle').checked=currentProject.cart_enabled!==false;
        document.getElementById('projectDownloadsToggle').checked=currentProject.downloads_enabled!==false;
        document.getElementById('projectFeaturedToggle').checked=currentProject.featured===true;
        // Load site settings to get latest licenses
        await loadLicenses();
        renderDomains();renderVideos();renderProjectLicenses();loadProjectPhotos();loadSeoData();
    }
    
    // Video management
    function parseVimeoId(input) {
        if (!input) return null;
        // Handle various Vimeo URL formats
        const patterns = [
            /vimeo\.com\/(\d+)/,
            /player\.vimeo\.com\/video\/(\d+)/,
            /^(\d+)$/
        ];
        for (const pattern of patterns) {
            const match = input.match(pattern);
            if (match) return match[1];
        }
        return null;
    }
    
    function getVimeoThumb(vimeoId) {
        return `https://vumbnail.com/${vimeoId}.jpg`;
    }
    
    function renderVideos() {
        const container = document.getElementById('projectVideos');
        const videos = currentProject.videos || [];
        
        if (videos.length === 0) {
            container.innerHTML = '<p style="font-size:0.8rem;color:var(--gray-400);padding:0.5rem 0;">No videos added</p>';
            return;
        }
        
        container.innerHTML = videos.map((video, idx) => `
            <div class="video-item">
                <div class="video-item-thumb">
                    <img src="${getVimeoThumb(video.vimeo_id)}" alt="">
                </div>
                <div class="video-item-info">
                    <div class="video-item-title">${video.title || 'Video ' + (idx + 1)}</div>
                    <div class="video-item-url">vimeo.com/${video.vimeo_id}</div>
                </div>
                <button class="video-item-remove" onclick="removeVideo(${idx})" title="Remove">Ã—</button>
            </div>
        `).join('');
    }
    
    async function addVideo() {
        const input = document.getElementById('newVideoInput');
        const vimeoId = parseVimeoId(input.value.trim());
        
        if (!vimeoId) {
            showToast('Invalid Vimeo URL or ID', 'error');
            return;
        }
        
        // Check if already added
        const videos = currentProject.videos || [];
        if (videos.some(v => v.vimeo_id === vimeoId)) {
            showToast('Video already added', 'error');
            return;
        }
        
        // Add video
        const newVideo = {
            vimeo_id: vimeoId,
            title: '',
            added_at: new Date().toISOString()
        };
        
        const updatedVideos = [...videos, newVideo];
        
        try {
            await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({ videos: updatedVideos })
            });
            currentProject.videos = updatedVideos;
            input.value = '';
            renderVideos();
            showToast('Video added!', 'success');
        } catch (e) {
            showToast('Error adding video', 'error');
        }
    }
    
    async function removeVideo(idx) {
        const videos = currentProject.videos || [];
        const updatedVideos = videos.filter((_, i) => i !== idx);
        
        try {
            await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({ videos: updatedVideos })
            });
            currentProject.videos = updatedVideos;
            renderVideos();
            showToast('Video removed', 'success');
        } catch (e) {
            showToast('Error removing video', 'error');
        }
    }
    
    // Project license management
    function renderProjectLicenses() {
        const container = document.getElementById('projectLicensesList');
        const allLicenses = siteSettings.licenses || DEFAULT_LICENSES;
        const projectLicenses = currentProject.enabled_licenses || allLicenses.map(l => l.id); // Default: all enabled
        
        container.innerHTML = allLicenses.map(lic => `
            <div class="project-license-item">
                <label>
                    <input type="checkbox" value="${lic.id}" ${projectLicenses.includes(lic.id) ? 'checked' : ''}>
                    ${lic.name}
                </label>
                <span class="price">$${(lic.price / 100).toFixed(2)}</span>
            </div>
        `).join('');
    }
    
    async function saveProjectLicenses() {
        const checkboxes = document.querySelectorAll('#projectLicensesList input[type="checkbox"]');
        const enabled_licenses = [];
        checkboxes.forEach(cb => {
            if (cb.checked) enabled_licenses.push(cb.value);
        });
        
        try {
            await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({ enabled_licenses })
            });
            currentProject.enabled_licenses = enabled_licenses;
            showToast('Licenses saved!', 'success');
        } catch (e) {
            showToast('Error saving licenses', 'error');
        }
    }
    
    async function saveProjectToggles(){
        const cart_enabled=document.getElementById('projectCartToggle').checked;
        const downloads_enabled=document.getElementById('projectDownloadsToggle').checked;
        const featured=document.getElementById('projectFeaturedToggle').checked;
        try{
            await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`,{
                method:'PATCH',
                headers:{'Content-Type':'application/json','x-admin-key':ADMIN_PASSWORD},
                body:JSON.stringify({cart_enabled,downloads_enabled,featured})
            });
            currentProject.cart_enabled=cart_enabled;
            currentProject.downloads_enabled=downloads_enabled;
            currentProject.featured=featured;
            showToast('Saved!','success');
            loadProjects();
        }catch(e){showToast('Error','error');}
    }
    
    async function loadProjects(){try{const r=await fetch(`${API_URL}/api/admin/projects`,{headers:{'x-admin-key':ADMIN_PASSWORD}});const d=await r.json();projects=d.projects||[];renderCollections();updateDropdown();}catch(e){document.getElementById('collectionsGrid').innerHTML='<div class="empty-state"><p>Error loading</p></div>';}}
    
    function renderCollections(){const g=document.getElementById('collectionsGrid');if(!projects.length){g.innerHTML='<div class="empty-state"><h3>No collections yet</h3><p>Create your first collection</p></div>';return;}
    g.innerHTML=projects.map((p,idx)=>`<div class="collection-card" draggable="true" data-id="${p.id}" data-index="${idx}" onclick="showProject('${p.id}')">
        <div class="drag-handle" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg></div>
        <div class="collection-cover">${p.cover_image_url?`<img src="${p.cover_image_url}">`:''}<span class="collection-status ${p.published?'published':'draft'}">${p.published?'Published':'Draft'}</span>${p.featured?'<span class="collection-featured">â­ Featured</span>':''}</div>
        <div class="collection-info"><div class="collection-title">${p.title}</div><div class="collection-meta"><span class="count">${p.photo_count||0} items</span>${p.event_date?`<span class="dot"></span><span>${formatDateRange(p.event_date, p.event_end_date)}</span>`:''}</div></div>
    </div>`).join('');
    initDragAndDrop();}
    
    function updateDropdown(){document.getElementById('uploadProjectSelect').innerHTML='<option value="">Choose...</option>'+projects.map(p=>`<option value="${p.id}" data-slug="${p.slug}">${p.title}</option>`).join('');}
    
    // Featured Projects Management
    let featuredProjects = [];
    
    function renderFeatured() {
        const g = document.getElementById('featuredGrid');
        featuredProjects = projects.filter(p => p.featured === true);
        // Sort by featured_order if available
        featuredProjects.sort((a, b) => (a.featured_order || 0) - (b.featured_order || 0));
        
        if (!featuredProjects.length) {
            g.innerHTML = '<div class="empty-state"><h3>No featured projects</h3><p>Add projects to feature them on the homepage</p></div>';
            return;
        }
        
        g.innerHTML = featuredProjects.map((p, idx) => `<div class="collection-card" draggable="true" data-id="${p.id}" data-index="${idx}" data-featured="true" onclick="showProject('${p.id}')">
            <div class="drag-handle" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg></div>
            <button class="collection-remove" onclick="event.stopPropagation();removeFromFeatured('${p.id}')" title="Remove from featured">Ã—</button>
            <div class="collection-cover">${p.cover_image_url ? `<img src="${p.cover_image_url}">` : ''}<span class="collection-status ${p.published ? 'published' : 'draft'}">${p.published ? 'Published' : 'Draft'}</span></div>
            <div class="collection-info"><div class="collection-title">${p.title}</div><div class="collection-meta"><span class="count">${p.photo_count || 0} items</span>${p.event_date ? `<span class="dot"></span><span>${formatDateRange(p.event_date, p.event_end_date)}</span>` : ''}</div></div>
        </div>`).join('');
        
        initFeaturedDragAndDrop();
    }
    
    function initFeaturedDragAndDrop() {
        const grid = document.getElementById('featuredGrid');
        const cards = grid.querySelectorAll('.collection-card');
        
        cards.forEach(card => {
            card.addEventListener('dragstart', handleFeaturedDragStart);
            card.addEventListener('dragend', handleFeaturedDragEnd);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleFeaturedDrop);
            card.addEventListener('dragenter', handleDragEnter);
            card.addEventListener('dragleave', handleDragLeave);
        });
    }
    
    let draggedFeaturedCard = null;
    
    function handleFeaturedDragStart(e) {
        draggedFeaturedCard = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.id);
    }
    
    function handleFeaturedDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('#featuredGrid .collection-card').forEach(card => {
            card.classList.remove('drag-over');
        });
        draggedFeaturedCard = null;
    }
    
    async function handleFeaturedDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');
        
        if (draggedFeaturedCard && this !== draggedFeaturedCard) {
            const fromIndex = parseInt(draggedFeaturedCard.dataset.index);
            const toIndex = parseInt(this.dataset.index);
            
            // Reorder in local array
            const [moved] = featuredProjects.splice(fromIndex, 1);
            featuredProjects.splice(toIndex, 0, moved);
            
            // Re-render
            renderFeatured();
            
            // Save new order to backend
            await saveFeaturedOrder();
        }
    }
    
    async function saveFeaturedOrder() {
        try {
            const order = featuredProjects.map((p, idx) => ({ id: p.id, featured_order: idx }));
            await fetch(`${API_URL}/api/admin/projects/reorder-featured`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({ order })
            });
            showToast('Order saved', 'success');
        } catch (e) {
            showToast('Could not save order', 'error');
        }
    }
    
    function openAddFeaturedModal() {
        document.getElementById('addFeaturedModal').classList.add('show');
        const list = document.getElementById('availableProjectsList');
        const nonFeatured = projects.filter(p => !p.featured && p.published);
        
        if (!nonFeatured.length) {
            list.innerHTML = '<div class="empty-state" style="padding:2rem;"><p>All published projects are already featured</p></div>';
            return;
        }
        
        list.innerHTML = nonFeatured.map(p => `
            <div class="available-project-item" onclick="addToFeatured('${p.id}')">
                <img src="${p.cover_image_url || ''}" alt="">
                <div class="available-project-item-info">
                    <div class="available-project-item-title">${p.title}</div>
                    <div class="available-project-item-meta">${p.photo_count || 0} photos${p.event_date ? ' â€¢ ' + formatDateRange(p.event_date, p.event_end_date) : ''}</div>
                </div>
            </div>
        `).join('');
    }
    
    async function addToFeatured(id) {
        try {
            await fetch(`${API_URL}/api/admin/projects/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({ featured: true, featured_order: featuredProjects.length })
            });
            // Update local data
            const project = projects.find(p => p.id === id);
            if (project) project.featured = true;
            closeModal('addFeaturedModal');
            renderFeatured();
            renderCollections();
            showToast('Added to featured!', 'success');
        } catch (e) {
            showToast('Error', 'error');
        }
    }
    
    async function removeFromFeatured(id) {
        try {
            await fetch(`${API_URL}/api/admin/projects/${id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({ featured: false, featured_order: null })
            });
            // Update local data
            const project = projects.find(p => p.id === id);
            if (project) project.featured = false;
            renderFeatured();
            renderCollections();
            showToast('Removed from featured', 'success');
        } catch (e) {
            showToast('Error', 'error');
        }
    }

    // Drag and drop for project ordering
    let draggedCard = null;
    
    function initDragAndDrop() {
        const grid = document.getElementById('collectionsGrid');
        const cards = grid.querySelectorAll('.collection-card');
        
        cards.forEach(card => {
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragenter', handleDragEnter);
            card.addEventListener('dragleave', handleDragLeave);
        });
    }
    
    function handleDragStart(e) {
        draggedCard = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.dataset.id);
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        document.querySelectorAll('.collection-card').forEach(card => {
            card.classList.remove('drag-over');
        });
        draggedCard = null;
    }
    
    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    function handleDragEnter(e) {
        e.preventDefault();
        if (this !== draggedCard) {
            this.classList.add('drag-over');
        }
    }
    
    function handleDragLeave(e) {
        this.classList.remove('drag-over');
    }
    
    async function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        this.classList.remove('drag-over');
        
        if (draggedCard && this !== draggedCard) {
            const fromId = draggedCard.dataset.id;
            const toId = this.dataset.id;
            const fromIndex = parseInt(draggedCard.dataset.index);
            const toIndex = parseInt(this.dataset.index);
            
            // Reorder in local array
            const [moved] = projects.splice(fromIndex, 1);
            projects.splice(toIndex, 0, moved);
            
            // Re-render
            renderCollections();
            
            // Save new order to backend
            await saveProjectOrder();
        }
    }
    
    async function saveProjectOrder() {
        try {
            const order = projects.map((p, idx) => ({ id: p.id, sort_order: idx }));
            await fetch(`${API_URL}/api/admin/projects/reorder`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({ order })
            });
            showToast('Order saved', 'success');
        } catch (e) {
            showToast('Could not save order', 'error');
        }
    }
    
    // Sets management - Pixieset style
    let projectSets = [];
    let manualSets = []; // Sets created via modal that may not have photos yet
    let currentSetFilter = null; // null = All Photos, string = specific set name
    
    function getProjectSets() {
        const sets = new Set();
        currentPhotos.forEach(photo => {
            if (photo.set_name) sets.add(photo.set_name);
        });
        // Merge in manually created sets
        manualSets.forEach(s => sets.add(s));
        return Array.from(sets).sort();
    }
    
    function renderSetsSidebar() {
        projectSets = getProjectSets();
        const container = document.getElementById('setsSidebarList');
        if (!container) return;
        
        // Count photos per set
        const allCount = currentPhotos.length;
        const favCount = currentPhotos.filter(p => p.is_favorite).length;
        const setCounts = {};
        projectSets.forEach(set => {
            setCounts[set] = currentPhotos.filter(p => p.set_name === set).length;
        });
        
        const escapeAttr = s => s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        
        container.innerHTML = `
            <div class="set-sidebar-item ${currentSetFilter === null ? 'active' : ''}" onclick="selectSet(null)">
                <span class="set-sidebar-item-icon">â˜°</span>
                <span class="set-sidebar-item-name">All Photos</span>
                <span class="set-sidebar-item-count">(${allCount})</span>
            </div>
            ${projectSets.map(set => `
                <div class="set-sidebar-item ${currentSetFilter === set ? 'active' : ''}" onclick="selectSet('${escapeAttr(set)}')">
                    <span class="set-sidebar-item-icon">â˜°</span>
                    <span class="set-sidebar-item-name">${set}</span>
                    <span class="set-sidebar-item-count">(${setCounts[set]})</span>
                    <button class="set-sidebar-item-menu" onclick="event.stopPropagation(); toggleSetMenu(this, '${escapeAttr(set)}')">â‹¯
                        <div class="set-context-menu" data-set="${escapeAttr(set)}">
                            <button class="set-context-menu-item" data-action="rename">âœï¸ Rename</button>
                            <button class="set-context-menu-item danger" data-action="delete">ðŸ—‘ Delete</button>
                        </div>
                    </button>
                </div>
            `).join('')}
        `;
        
        // Add event listeners for context menu items
        container.querySelectorAll('.set-context-menu').forEach(menu => {
            const setName = menu.dataset.set;
            menu.querySelector('[data-action="rename"]').addEventListener('click', (e) => {
                e.stopPropagation();
                renameSet(setName);
            });
            menu.querySelector('[data-action="delete"]').addEventListener('click', (e) => {
                e.stopPropagation();
                confirmDeleteSet(setName);
            });
        });
    }
    
    // Close any open set menu when clicking elsewhere
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.set-sidebar-item-menu')) {
            document.querySelectorAll('.set-context-menu.show').forEach(m => m.classList.remove('show'));
        }
    });
    
    function toggleSetMenu(btn, setName) {
        // Close any other open menus
        document.querySelectorAll('.set-context-menu.show').forEach(m => m.classList.remove('show'));
        const menu = btn.querySelector('.set-context-menu');
        if (menu) menu.classList.toggle('show');
    }
    
    function renameSet(oldName) {
        document.querySelectorAll('.set-context-menu.show').forEach(m => m.classList.remove('show'));
        const newName = prompt('Rename set:', oldName);
        if (!newName || newName.trim() === '' || newName.trim() === oldName) return;
        const trimmed = newName.trim();
        if (projectSets.includes(trimmed)) {
            showToast('A set with that name already exists', 'error');
            return;
        }
        // Update all photos in this set
        const photosInSet = currentPhotos.filter(p => p.set_name === oldName);
        let done = 0;
        Promise.all(photosInSet.map(async photo => {
            try {
                await fetch(`${API_URL}/api/admin/photos/${photo.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                    body: JSON.stringify({ set_name: trimmed })
                });
                photo.set_name = trimmed;
                done++;
            } catch (e) {}
        })).then(() => {
            if (currentSetFilter === oldName) currentSetFilter = trimmed;
            renderSetsSidebar();
            renderFilteredPhotos();
            const titleEl = document.getElementById('currentSetTitle');
            if (titleEl && currentSetFilter === trimmed) titleEl.textContent = trimmed;
            showToast(`Renamed to "${trimmed}" (${done} photos updated)`, 'success');
        });
    }
    
    function confirmDeleteSet(setName) {
        document.querySelectorAll('.set-context-menu.show').forEach(m => m.classList.remove('show'));
        if (confirm(`Delete set "${setName}"?\n\nPhotos will be moved to "All Photos" (not deleted).`)) {
            deleteSet(setName);
        }
    }

    async function deleteSet(setName) {
        // Unassign all photos from this set
        const photosInSet = currentPhotos.filter(p => p.set_name === setName);
        for (const photo of photosInSet) {
            try {
                await fetch(`${API_URL}/api/admin/photos/${photo.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                    body: JSON.stringify({ set_name: null })
                });
                photo.set_name = null;
            } catch (e) {}
        }
        
        // Remove from arrays
        projectSets = projectSets.filter(s => s !== setName);
        manualSets = manualSets.filter(s => s !== setName);
        
        // Go back to All Photos
        selectSet(null);
        renderSetsSidebar();
        showToast('Set deleted', 'success');
    }
    
    function selectSet(setName) {
        currentSetFilter = setName;
        selectedPhotos.clear();
        updateBulkBar();
        renderSetsSidebar();
        renderFilteredPhotos();
        
        // Update header title
        const titleEl = document.getElementById('currentSetTitle');
        if (setName === null) {
            titleEl.textContent = 'All Photos';
        } else if (setName === '__favorites__') {
            titleEl.textContent = 'Favorites';
        } else {
            titleEl.textContent = setName;
        }
        
        // Show upload zone for custom sets (not All Photos or Favorites)
        const uploadZone = document.getElementById('setUploadZone');
        if (setName && setName !== '__favorites__') {
            uploadZone.style.display = 'block';
        } else {
            uploadZone.style.display = currentPhotos.length === 0 ? 'block' : 'none';
        }
    }
    
    function renderFilteredPhotos() {
        let photos = currentPhotos;
        if (currentSetFilter === '__favorites__') {
            photos = currentPhotos.filter(p => p.is_favorite);
        } else if (currentSetFilter !== null) {
            photos = currentPhotos.filter(p => p.set_name === currentSetFilter);
        }
        renderPhotosGrid(photos);
    }
    
    function openNewSetModal() {
        document.getElementById('newSetName').value = '';
        document.getElementById('newSetDescription').value = '';
        document.getElementById('setDescCount').textContent = '0';
        document.getElementById('newSetModal').classList.add('show');
    }
    
    function createNewSet() {
        const setName = document.getElementById('newSetName').value.trim();
        if (!setName) { showToast('Enter a set name', 'error'); return; }
        if (projectSets.includes(setName)) { showToast('Set already exists', 'error'); return; }
        manualSets.push(setName);
        projectSets = getProjectSets();
        closeModal('newSetModal');
        renderSetsSidebar();
        selectSet(setName);
        showToast('Set created! Upload photos to this set.', 'success');
    }
    
    async function updatePhotoSet(photoId, setName) {
        try {
            await fetch(`${API_URL}/api/admin/photos/${photoId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({ set_name: setName || null })
            });
            const photo = currentPhotos.find(p => p.id === photoId);
            if (photo) photo.set_name = setName || null;
            showToast('Set updated', 'success');
        } catch (e) {
            showToast('Error', 'error');
        }
    }
    
    async function loadProjectPhotos(){
        nextPhotoSeq = 0; // Reset so it recalculates from loaded photos
        const g=document.getElementById('photosGrid');
        g.innerHTML='<div class="loading"><div class="spinner"></div></div>';
        try {
            let d;
            try {
                const r=await fetch(`${API_URL}/api/admin/projects/${currentProject.id}/photos`,{headers:{'x-admin-key':ADMIN_PASSWORD}});
                d=await r.json();
            } catch(e) {
                const r2=await fetch(`${API_URL}/api/projects/${currentProject.slug}`);
                d=await r2.json();
            }
            currentPhotos=d.photos||d||[];
            if(!Array.isArray(currentPhotos))currentPhotos=[];
            currentPhotos.sort((a,b) => (a.sort_order||0) - (b.sort_order||0));
            const coverUrl=d.project?.cover_image_url||currentProject.cover_image_url;
            
            // Reset filter and manual sets, render sidebar
            currentSetFilter = null;
            manualSets = [];
            renderSetsSidebar();
            
            // Bind set upload listeners (DOM now exists)
            setupSetUpload();
            
            // Show upload zone if no photos
            const uploadZone = document.getElementById('setUploadZone');
            if (uploadZone) {
                uploadZone.style.display = currentPhotos.length === 0 ? 'block' : 'none';
            }
            
            // Update title
            const titleEl = document.getElementById('currentSetTitle');
            if (titleEl) titleEl.textContent = 'All Photos';
            
            renderPhotosGrid(currentPhotos);
        } catch(e) {
            g.innerHTML='<div class="empty-state"><p>Error loading photos</p></div>';
        }
    }
    
    function renderPhotosGrid(photos) {
        const g = document.getElementById('photosGrid');
        const coverUrl = currentProject?.cover_image_url;
        
        if(!photos.length){
            g.innerHTML='<div class="empty-state" style="grid-column:1/-1;padding:3rem;text-align:center;"><p style="color:var(--gray-500);">No photos in this set</p></div>';
            return;
        }
        
        // Get all sets for dropdown
        projectSets = getProjectSets();
        
        g.innerHTML=photos.map(photo=>{
            const img=photo.thumbnail_url||photo.large_url||photo.original_url||'';
            const isCover=coverUrl&&(coverUrl===img||coverUrl===photo.original_url||coverUrl===photo.large_url);
            return`<div class="photo-card ${isCover?'is-cover':''}" data-id="${photo.id}" draggable="true">
                <div class="photo-select-checkbox" onclick="event.stopPropagation(); togglePhotoSelect('${photo.id}', this)">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 13l4 4L19 7"/></svg>
                </div>
                <div class="photo-thumb">
                    <img src="${img}">
                    ${isCover?'<span class="photo-cover-badge">Cover</span>':''}
                    <div class="photo-actions-overlay">
                        <button class="photo-action-btn" onclick="event.stopPropagation();setCover('${photo.id}')" title="Set cover">â­</button>
                        <button class="photo-action-btn" onclick="event.stopPropagation();deletePhoto('${photo.id}')" title="Delete">âœ•</button>
                    </div>
                </div>
                <div class="photo-body">
                    <select class="photo-set-select" id="set-${photo.id}" onchange="updatePhotoSet('${photo.id}', this.value); renderSetsSidebar();">
                        <option value="">No set</option>
                        ${projectSets.map(set => `<option value="${set}" ${photo.set_name === set ? 'selected' : ''}>${set}</option>`).join('')}
                    </select>
                    <input type="text" class="photo-tags-input" id="tags-${photo.id}" value="${(photo.people||[]).join(', ')}" placeholder="Tag people...">
                    <button class="photo-save-btn" onclick="saveTags('${photo.id}')">Save Tags</button>
                </div>
            </div>`;
        }).join('');
        initPhotoDragDrop();
    }

    // â”€â”€ Photo Drag & Drop â”€â”€

    function initPhotoDragDrop() {
        const grid = document.getElementById('photosGrid');
        const cards = grid.querySelectorAll('.photo-card');

        cards.forEach(card => {
            card.addEventListener('dragstart', e => {
                // Don't drag if interacting with inputs/selects/buttons
                if (e.target.closest('input, select, button')) { e.preventDefault(); return; }
                draggedCard = card;
                card.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', card.dataset.id);
            });

            card.addEventListener('dragend', () => {
                card.classList.remove('dragging');
                grid.querySelectorAll('.photo-card').forEach(c => c.classList.remove('drag-over'));
                draggedCard = null;
            });

            card.addEventListener('dragover', e => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (draggedCard && card !== draggedCard) {
                    card.classList.add('drag-over');
                }
            });

            card.addEventListener('dragleave', () => {
                card.classList.remove('drag-over');
            });

            card.addEventListener('drop', e => {
                e.preventDefault();
                card.classList.remove('drag-over');
                if (!draggedCard || card === draggedCard) return;

                // Reorder in DOM
                const allCards = [...grid.querySelectorAll('.photo-card')];
                const fromIdx = allCards.indexOf(draggedCard);
                const toIdx = allCards.indexOf(card);

                if (fromIdx < toIdx) {
                    card.after(draggedCard);
                } else {
                    card.before(draggedCard);
                }

                // Reorder in data & save
                const newOrder = [...grid.querySelectorAll('.photo-card')].map(c => c.dataset.id);
                reorderPhotos(newOrder);
            });
        });
    }

    async function reorderPhotos(orderedIds) {
        // Update currentPhotos order
        const photoMap = {};
        currentPhotos.forEach(p => photoMap[p.id] = p);
        currentPhotos = orderedIds.map(id => photoMap[id]).filter(Boolean);

        // Save sort_order to API
        try {
            const promises = orderedIds.map((id, idx) =>
                fetch(`${API_URL}/api/admin/photos/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                    body: JSON.stringify({ sort_order: idx })
                })
            );
            await Promise.all(promises);
            showToast('Order saved!', 'success');
        } catch(e) {
            showToast('Error saving order', 'error');
        }
    }
    
    // â”€â”€ Bulk Selection â”€â”€
    let selectedPhotos = new Set();
    
    function togglePhotoSelect(photoId, checkboxEl) {
        const card = checkboxEl.closest('.photo-card');
        if (selectedPhotos.has(photoId)) {
            selectedPhotos.delete(photoId);
            card.classList.remove('selected');
            checkboxEl.classList.remove('checked');
        } else {
            selectedPhotos.add(photoId);
            card.classList.add('selected');
            checkboxEl.classList.add('checked');
        }
        updateBulkBar();
    }
    
    function updateBulkBar() {
        const bar = document.getElementById('bulkActionBar');
        const countEl = document.getElementById('bulkCount');
        const selectBtn = document.getElementById('selectAllBtn');
        const moveSelect = document.getElementById('bulkMoveSelect');
        
        if (selectedPhotos.size > 0) {
            bar.classList.add('show');
            countEl.textContent = `${selectedPhotos.size} selected`;
            selectBtn.textContent = 'â˜‘ Deselect All';
            
            // Update move dropdown with current sets
            const sets = getProjectSets();
            moveSelect.innerHTML = '<option value="">Move to set...</option><option value="__none__">No set</option>' +
                sets.map(s => `<option value="${s}">${s}</option>`).join('');
        } else {
            bar.classList.remove('show');
            selectBtn.textContent = 'â˜ Select All';
        }
    }
    
    function toggleSelectAll() {
        const grid = document.getElementById('photosGrid');
        const cards = grid.querySelectorAll('.photo-card');
        
        if (selectedPhotos.size > 0) {
            // Deselect all
            bulkDeselectAll();
        } else {
            // Select all visible
            cards.forEach(card => {
                const id = card.dataset.id;
                selectedPhotos.add(id);
                card.classList.add('selected');
                const cb = card.querySelector('.photo-select-checkbox');
                if (cb) cb.classList.add('checked');
            });
            updateBulkBar();
        }
    }
    
    function bulkDeselectAll() {
        selectedPhotos.clear();
        document.querySelectorAll('.photo-card.selected').forEach(c => c.classList.remove('selected'));
        document.querySelectorAll('.photo-select-checkbox.checked').forEach(c => c.classList.remove('checked'));
        updateBulkBar();
    }
    
    async function bulkDelete() {
        const count = selectedPhotos.size;
        if (!count) return;
        if (!confirm(`Delete ${count} photo${count > 1 ? 's' : ''}? This cannot be undone.`)) return;
        
        showToast(`Deleting ${count} photos...`, '');
        let deleted = 0;
        const ids = [...selectedPhotos];
        
        // Delete in batches of 5
        for (let i = 0; i < ids.length; i += 5) {
            const batch = ids.slice(i, i + 5);
            await Promise.all(batch.map(async id => {
                try {
                    await fetch(`${API_URL}/api/admin/photos/${id}`, {
                        method: 'DELETE', headers: { 'x-admin-key': ADMIN_PASSWORD }
                    });
                    deleted++;
                } catch(e) {}
            }));
        }
        
        selectedPhotos.clear();
        showToast(`${deleted} photos deleted`, 'success');
        loadProjectPhotos();
        loadProjects();
    }
    
    async function bulkMoveToSet(setName) {
        if (!setName) return;
        const count = selectedPhotos.size;
        if (!count) return;
        
        const actualSet = setName === '__none__' ? null : setName;
        const label = actualSet || 'No set';
        showToast(`Moving ${count} photos to "${label}"...`, '');
        
        let moved = 0;
        const ids = [...selectedPhotos];
        
        for (let i = 0; i < ids.length; i += 5) {
            const batch = ids.slice(i, i + 5);
            await Promise.all(batch.map(async id => {
                try {
                    await fetch(`${API_URL}/api/admin/photos/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                        body: JSON.stringify({ set_name: actualSet })
                    });
                    moved++;
                } catch(e) {}
            }));
        }
        
        selectedPhotos.clear();
        showToast(`${moved} photos moved to "${label}"`, 'success');
        await reloadProjectPhotosKeepSet();
    }
    
    async function bulkMoveToFront() {
        const count = selectedPhotos.size;
        if (!count) return;
        
        showToast(`Moving ${count} photos to front...`, '');
        
        // Find the minimum sort_order in current photos
        const minOrder = Math.min(...currentPhotos.map(p => p.sort_order || 0));
        const ids = [...selectedPhotos];
        
        // Assign new sort orders starting from minOrder - count
        let newOrder = minOrder - ids.length;
        
        for (let i = 0; i < ids.length; i++) {
            try {
                await fetch(`${API_URL}/api/admin/photos/${ids[i]}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                    body: JSON.stringify({ sort_order: newOrder + i })
                });
            } catch(e) {}
        }
        
        selectedPhotos.clear();
        showToast(`${count} photos moved to front`, 'success');
        await reloadProjectPhotosKeepSet();
    }
    
    async function bulkMoveToBack() {
        const count = selectedPhotos.size;
        if (!count) return;
        
        showToast(`Moving ${count} photos to back...`, '');
        
        // Find the maximum sort_order in current photos
        const maxOrder = Math.max(...currentPhotos.map(p => p.sort_order || 0));
        const ids = [...selectedPhotos];
        
        // Assign new sort orders starting from maxOrder + 1
        let newOrder = maxOrder + 1;
        
        for (let i = 0; i < ids.length; i++) {
            try {
                await fetch(`${API_URL}/api/admin/photos/${ids[i]}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                    body: JSON.stringify({ sort_order: newOrder + i })
                });
            } catch(e) {}
        }
        
        selectedPhotos.clear();
        showToast(`${count} photos moved to back`, 'success');
        await reloadProjectPhotosKeepSet();
    }
    
    async function saveTags(id){const people=document.getElementById(`tags-${id}`).value.split(',').map(s=>s.trim()).filter(Boolean);try{await fetch(`${API_URL}/api/admin/photos/${id}`,{method:'PUT',headers:{'Content-Type':'application/json','x-admin-key':ADMIN_PASSWORD},body:JSON.stringify({people})});showToast('Saved!','success');}catch(e){showToast('Error','error');}}
    async function saveAllTags(){showToast('Saving...','');let n=0;for(const p of currentPhotos){const el=document.getElementById(`tags-${p.id}`);if(!el)continue;const people=el.value.split(',').map(s=>s.trim()).filter(Boolean);try{await fetch(`${API_URL}/api/admin/photos/${p.id}`,{method:'PUT',headers:{'Content-Type':'application/json','x-admin-key':ADMIN_PASSWORD},body:JSON.stringify({people})});n++;}catch(e){}}showToast(`${n} saved!`,'success');}
    async function setCover(id){const photo=currentPhotos.find(p=>p.id===id);if(!photo)return;const url=photo.original_url||photo.large_url||photo.thumbnail_url;try{await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`,{method:'PATCH',headers:{'Content-Type':'application/json','x-admin-key':ADMIN_PASSWORD},body:JSON.stringify({cover_image_url:url})});currentProject.cover_image_url=url;document.getElementById('projectCover').src=url;loadProjectPhotos();showToast('Cover set!','success');}catch(e){showToast('Error','error');}}
    async function deletePhoto(id){if(!confirm('Delete?'))return;try{await fetch(`${API_URL}/api/admin/photos/${id}`,{method:'DELETE',headers:{'x-admin-key':ADMIN_PASSWORD}});showToast('Deleted','success');loadProjectPhotos();loadProjects();}catch(e){showToast('Error','error');}}
    
    function renderDomains(){const list=document.getElementById('projectDomains');const domains=currentProject.whitelisted_domains||[];if(!domains.length){list.innerHTML='<span style="font-size:0.75rem;color:var(--gray-400);">None</span>';return;}list.innerHTML=domains.map(d=>`<span class="domain-tag">${d}<button onclick="removeDomain('${d}')">Ã—</button></span>`).join('');}
    async function addDomain(){const input=document.getElementById('newDomainInput');let domain=input.value.trim().toLowerCase();if(!domain)return;if(!domain.startsWith('@'))domain='@'+domain;if(!domain.includes('.')){showToast('Invalid domain','error');return;}const domains=currentProject.whitelisted_domains||[];if(domains.includes(domain)){showToast('Already added','error');return;}domains.push(domain);try{await fetch(`${API_URL}/api/gallery-access/domains/${currentProject.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({whitelisted_domains:domains})});currentProject.whitelisted_domains=domains;renderDomains();input.value='';showToast('Added','success');}catch(e){showToast('Error','error');}}
    async function removeDomain(domain){const domains=(currentProject.whitelisted_domains||[]).filter(d=>d!==domain);try{await fetch(`${API_URL}/api/gallery-access/domains/${currentProject.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({whitelisted_domains:domains})});currentProject.whitelisted_domains=domains;renderDomains();showToast('Removed','success');}catch(e){showToast('Error','error');}}
    
    async function saveProjectCode(){const code=document.getElementById('projectCode').value.trim().toUpperCase()||null;try{await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`,{method:'PATCH',headers:{'Content-Type':'application/json','x-admin-key':ADMIN_PASSWORD},body:JSON.stringify({download_code:code})});currentProject.download_code=code;showToast('Saved!','success');}catch(e){showToast('Error','error');}}
    async function saveProjectBrands(){const brands=document.getElementById('projectBrands').value.split(',').map(s=>s.trim()).filter(Boolean);try{await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`,{method:'PATCH',headers:{'Content-Type':'application/json','x-admin-key':ADMIN_PASSWORD},body:JSON.stringify({brands:brands.length?brands:null})});currentProject.brands=brands;showToast('Saved!','success');}catch(e){showToast('Error','error');}}
    async function togglePublishCurrent(){const newState=!currentProject.published;try{await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`,{method:'PATCH',headers:{'Content-Type':'application/json','x-admin-key':ADMIN_PASSWORD},body:JSON.stringify({published:newState})});currentProject.published=newState;document.getElementById('publishBtn').textContent=newState?'Unpublish':'Publish';showToast(newState?'Published!':'Unpublished','success');loadProjects();}catch(e){showToast('Error','error');}}
    
    function openNewProjectModal(){
        document.getElementById('newProjectModal').classList.add('show');
        // Reset to step 1
        goToStep(1);
        // Clear all fields
        document.getElementById('newTitle').value='';
        document.getElementById('newDate').value='';
        document.getElementById('newEndDate').value='';
        document.getElementById('newVenue').value='';
        document.getElementById('newBrands').value='';
        document.getElementById('newCode').value='';
        document.getElementById('newSeoTitle').value='';
        document.getElementById('newSeoDesc').value='';
        document.getElementById('newSeoKeywords').value='';
        document.getElementById('newSeoTitleCount').textContent='0';
        document.getElementById('newSeoDescCount').textContent='0';
        // Clear tag selections
        document.querySelectorAll('#newTagsSelector .tag-option').forEach(t=>t.classList.remove('selected'));
        // Reset preview
        updateNewSeoPreview();
    }
    
    function goToStep(step) {
        // Update step indicators
        document.querySelectorAll('.modal-step').forEach((el, idx) => {
            el.classList.remove('active', 'completed');
            if (idx + 1 < step) el.classList.add('completed');
            if (idx + 1 === step) el.classList.add('active');
        });
        // Show correct content
        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.getElementById('newStep' + step).classList.add('active');
        
        // If going to step 2, auto-generate SEO if fields are empty
        if (step === 2) {
            const seoTitle = document.getElementById('newSeoTitle').value;
            if (!seoTitle) {
                autoGenerateNewSeo();
            }
            updateNewSeoPreview();
        }
    }
    
    function updateNewSeoPreview() {
        const title = document.getElementById('newSeoTitle')?.value || document.getElementById('newTitle')?.value || 'Page Title';
        const desc = document.getElementById('newSeoDesc')?.value || 'Your meta description will appear here...';
        const projectTitle = document.getElementById('newTitle')?.value || 'project';
        const slug = projectTitle.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        
        document.getElementById('newPreviewTitle').textContent = title || 'Page Title';
        document.getElementById('newPreviewUrl').textContent = `sfeventphoto.com/project/${slug || '...'}`;
        document.getElementById('newPreviewDesc').textContent = desc;
    }
    
    function autoGenerateNewSeo() {
        const title = document.getElementById('newTitle').value || '';
        const venue = document.getElementById('newVenue').value || '';
        const brands = document.getElementById('newBrands').value || '';
        const date = document.getElementById('newDate').value;
        const tags = Array.from(document.querySelectorAll('#newTagsSelector .tag-option.selected')).map(t => t.dataset.tag);
        
        if (!title) {
            showToast('Enter a title first', 'error');
            return;
        }
        
        // Extract city from venue if possible
        let city = 'San Francisco';
        const venueLC = venue.toLowerCase();
        if (venueLC.includes('los angeles') || venueLC.includes('la ') || venueLC.includes(', la')) city = 'Los Angeles';
        else if (venueLC.includes('new york') || venueLC.includes('nyc')) city = 'New York';
        else if (venueLC.includes('san francisco') || venueLC.includes('sf')) city = 'San Francisco';
        else if (venue) city = venue.split(',').pop()?.trim() || city;
        
        // Determine event type from tags
        let eventType = 'event';
        if (tags.includes('Conference')) eventType = 'conference';
        else if (tags.includes('Corporate')) eventType = 'corporate event';
        else if (tags.includes('Party')) eventType = 'party';
        else if (tags.includes('Activation')) eventType = 'brand activation';
        else if (tags.includes('Portraits')) eventType = 'portrait';
        else if (tags.includes('PR')) eventType = 'PR event';
        else if (tags.includes('Video')) eventType = 'video production';
        
        // Generate SEO Title (max 60 chars)
        let seoTitle = `${title} Photos | ${city}`;
        if (seoTitle.length < 50) seoTitle += ' | SF Event Photo';
        if (seoTitle.length > 60) seoTitle = `${title} Photos | SF Event Photo`;
        if (seoTitle.length > 60) seoTitle = seoTitle.substring(0, 57) + '...';
        
        // Generate SEO Description (max 160 chars)
        let seoDesc = `SF Event Photo captured ${title}`;
        if (venue && seoDesc.length + venue.length + 5 < 120) seoDesc += ` at ${venue}`;
        if (date) {
            const dateStr = new Date(date).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            if (seoDesc.length + dateStr.length + 5 < 130) seoDesc += `, ${dateStr}`;
        }
        seoDesc += `. Professional ${eventType} photography coverage.`;
        if (seoDesc.length > 160) seoDesc = seoDesc.substring(0, 157) + '...';
        
        // Generate Keywords
        let keywords = [];
        if (brands) keywords = brands.split(',').map(b => b.trim().toLowerCase());
        keywords.push(title.toLowerCase());
        keywords.push(`${eventType} photography`);
        keywords.push(`${city.toLowerCase()} event photographer`);
        keywords.push('corporate event photos');
        if (venue) keywords.push(venue.toLowerCase());
        // Dedupe and limit
        keywords = [...new Set(keywords)].slice(0, 8);
        
        // Set values
        document.getElementById('newSeoTitle').value = seoTitle;
        document.getElementById('newSeoDesc').value = seoDesc;
        document.getElementById('newSeoKeywords').value = keywords.join(', ');
        
        // Update counts
        document.getElementById('newSeoTitleCount').textContent = seoTitle.length;
        document.getElementById('newSeoDescCount').textContent = seoDesc.length;
        
        updateNewSeoPreview();
    }
    
    function togglePasswordField() {
        const isPrivate = document.getElementById('editPrivate').checked;
        document.getElementById('passwordFieldWrapper').style.display = isPrivate ? 'block' : 'none';
        if (!isPrivate) document.getElementById('editPassword').value = '';
    }
    
    function openEditProjectModal(){
        document.getElementById('editProjectModal').classList.add('show');
        document.getElementById('editTitle').value=currentProject.title||'';
        document.getElementById('editDate').value=currentProject.event_date?.substring(0,10)||'';
        document.getElementById('editEndDate').value=currentProject.event_end_date?.substring(0,10)||'';
        document.getElementById('editVenue').value=currentProject.venue||'';
        document.getElementById('editPrivate').checked = currentProject.is_private || false;
        document.getElementById('editPassword').value = currentProject.gallery_password || '';
        document.getElementById('passwordFieldWrapper').style.display = currentProject.is_private ? 'block' : 'none';
        setSelectedTags('editTagsSelector',currentProject.tags||[]);
        
        // SEO fields
        document.getElementById('editSeoTitle').value = currentProject.seo_title || '';
        document.getElementById('editSeoDescription').value = currentProject.seo_description || '';
        document.getElementById('editSeoKeywords').value = currentProject.seo_keywords || '';
        updateEditSeoCount();
    }
    
    function updateEditSeoCount() {
        const title = document.getElementById('editSeoTitle').value;
        const desc = document.getElementById('editSeoDescription').value;
        document.getElementById('editSeoTitleCount').textContent = title.length;
        document.getElementById('editSeoDescCount').textContent = desc.length;
    }
    
    // Add event listeners for SEO character counts
    document.addEventListener('DOMContentLoaded', () => {
        const seoTitle = document.getElementById('editSeoTitle');
        const seoDesc = document.getElementById('editSeoDescription');
        if (seoTitle) seoTitle.addEventListener('input', updateEditSeoCount);
        if (seoDesc) seoDesc.addEventListener('input', updateEditSeoCount);
    });
    function closeModal(id){document.getElementById(id).classList.remove('show');}
    
    // Sidebar tabs
    function switchSidebarTab(tab) {
        document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.sidebar-tab-content').forEach(t => t.classList.remove('active'));
        document.querySelector(`.sidebar-tab[onclick*="${tab}"]`).classList.add('active');
        document.getElementById(tab + 'Tab').classList.add('active');
        if (tab === 'activity') loadActivity();
    }
    
    // Activity log
    async function loadActivity() {
        const list = document.getElementById('activityList');
        list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        try {
            const r = await fetch(`${API_URL}/api/download-logs/${currentProject.id}`, {
                headers: { 'x-admin-key': ADMIN_PASSWORD }
            });
            const data = await r.json();
            const logs = data.logs || [];
            if (!logs.length) {
                list.innerHTML = '<p style="color:var(--gray-400);font-size:0.85rem;text-align:center;padding:1rem;">No activity yet</p>';
                return;
            }
            list.innerHTML = logs.map(log => `
                <div class="activity-item">
                    <span class="activity-type ${log.type || 'download'}">${log.type || 'download'}</span>
                    <div class="activity-email">${log.email || 'Unknown'}</div>
                    ${log.filename ? `<div class="activity-file">${log.filename}</div>` : ''}
                    <div class="activity-meta">${new Date(log.created_at).toLocaleString()}</div>
                </div>
            `).join('');
        } catch (e) {
            list.innerHTML = '<p style="color:var(--gray-400);font-size:0.85rem;text-align:center;padding:1rem;">Could not load activity</p>';
        }
    }
    
    function openUploadForProject(){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.getElementById('uploadTab').classList.add('active');setActiveNav(1);updateDropdown();document.getElementById('uploadProjectSelect').value=currentProject.id;}
    
    async function createProject(e){
        if(e)e.preventDefault();
        const title=document.getElementById('newTitle').value;
        if(!title){showToast('Title is required','error');goToStep(1);return;}
        
        const code=document.getElementById('newCode').value.trim().toUpperCase()||null;
        const endDate=document.getElementById('newEndDate').value||null;
        const tags=getSelectedTags('newTagsSelector');
        const brandsStr=document.getElementById('newBrands').value;
        const brands=brandsStr?brandsStr.split(',').map(b=>b.trim()).filter(Boolean):null;
        
        // SEO data
        const seo_title=document.getElementById('newSeoTitle').value||null;
        const seo_description=document.getElementById('newSeoDesc').value||null;
        const seo_keywords=document.getElementById('newSeoKeywords').value||null;
        
        try{
            const r=await fetch(`${API_URL}/api/admin/projects`,{
                method:'POST',
                headers:{'Content-Type':'application/json','x-admin-key':ADMIN_PASSWORD},
                body:JSON.stringify({
                    title,
                    slug:title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''),
                    event_date:document.getElementById('newDate').value||null,
                    event_end_date:endDate,
                    venue:document.getElementById('newVenue').value||null,
                    download_code:code,
                    tags:tags,
                    brands:brands,
                    seo_title,
                    seo_description,
                    seo_keywords,
                    published:false
                })
            });
            const d=await r.json();
            if(d.error)throw new Error(d.error);
            closeModal('newProjectModal');
            setSelectedTags('newTagsSelector',[]);
            showToast('Collection created with SEO!','success');
            loadProjects();
        }catch(err){showToast('Error: '+err.message,'error');}
    }
    async function saveEditProject(){
        const tags = getSelectedTags('editTagsSelector');
        const isPrivate = document.getElementById('editPrivate').checked;
        const galleryPassword = document.getElementById('editPassword').value || null;
        
        // SEO fields
        const seoTitle = document.getElementById('editSeoTitle').value || null;
        const seoDescription = document.getElementById('editSeoDescription').value || null;
        const seoKeywords = document.getElementById('editSeoKeywords').value || null;
        
        try {
            await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify({
                    title: document.getElementById('editTitle').value,
                    event_date: document.getElementById('editDate').value || null,
                    event_end_date: document.getElementById('editEndDate').value || null,
                    venue: document.getElementById('editVenue').value || null,
                    tags: tags,
                    is_private: isPrivate,
                    gallery_password: isPrivate ? galleryPassword : null,
                    seo_title: seoTitle,
                    seo_description: seoDescription,
                    seo_keywords: seoKeywords
                })
            });
            
            closeModal('editProjectModal');
            showToast('Saved!', 'success');
            
            currentProject.title = document.getElementById('editTitle').value;
            currentProject.event_date = document.getElementById('editDate').value;
            currentProject.event_end_date = document.getElementById('editEndDate').value;
            currentProject.tags = tags;
            currentProject.is_private = isPrivate;
            currentProject.gallery_password = galleryPassword;
            currentProject.seo_title = seoTitle;
            currentProject.seo_description = seoDescription;
            currentProject.seo_keywords = seoKeywords;
            
            document.getElementById('projectTitle').textContent = currentProject.title;
            document.getElementById('projectMeta').textContent = formatDateRange(currentProject.event_date, currentProject.event_end_date) + ` â€¢ ${currentProject.photo_count || 0} photos`;
            
            // Update sidebar SEO tab if open
            if (document.getElementById('seoTitle')) {
                document.getElementById('seoTitle').value = seoTitle || '';
                document.getElementById('seoDescription').value = seoDescription || '';
                document.getElementById('seoKeywords').value = seoKeywords || '';
            }
            
            loadProjects();
        } catch(e) {
            showToast('Error', 'error');
        }
    }
    async function deleteCurrentProject(){if(!confirm('Delete collection and ALL photos?'))return;try{await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`,{method:'DELETE',headers:{'x-admin-key':ADMIN_PASSWORD}});closeModal('editProjectModal');showToast('Deleted','success');loadProjects();showCollections();}catch(e){showToast('Error','error');}}
    
    async function duplicateCurrentProject(){
        if(!confirm('Duplicate this collection? (Photos will also be duplicated)'))return;
        try{
            const res = await fetch(`${API_URL}/api/admin/projects/${currentProject.id}/duplicate`,{
                method:'POST',
                headers:{'x-admin-key':ADMIN_PASSWORD}
            });
            if(!res.ok) throw new Error('Failed to duplicate');
            const data = await res.json();
            closeModal('editProjectModal');
            showToast('Duplicated! New collection created.','success');
            loadProjects();
        }catch(e){showToast('Error: '+e.message,'error');}
    }
    
    function setupUpload(){
        // Main upload zone (Upload tab)
        const zone=document.getElementById('uploadZone');
        const input=document.getElementById('fileInput');
        if (zone && input) {
            zone.addEventListener('click',()=>input.click());
            zone.addEventListener('dragover',e=>{e.preventDefault();zone.classList.add('dragover');});
            zone.addEventListener('dragleave',()=>zone.classList.remove('dragover'));
            zone.addEventListener('drop',e=>{e.preventDefault();zone.classList.remove('dragover');handleFiles(e.dataTransfer.files);});
            input.addEventListener('change',e=>handleFiles(e.target.files));
        }
    }
    
    let setUploadBound = false;
    function setupSetUpload() {
        if (setUploadBound) return;
        const setZone = document.getElementById('setUploadZone');
        const setInput = document.getElementById('setFileInput');
        if (setZone && setInput) {
            setZone.addEventListener('dragover', e => { e.preventDefault(); setZone.classList.add('dragover'); });
            setZone.addEventListener('dragleave', () => setZone.classList.remove('dragover'));
            setZone.addEventListener('drop', e => { e.preventDefault(); setZone.classList.remove('dragover'); handleSetFiles(e.dataTransfer.files); });
            setInput.addEventListener('change', e => handleSetFiles(e.target.files));
            setUploadBound = true;
        }
    }
    
    function triggerSetUpload() {
        setupSetUpload(); // ensure bound
        document.getElementById('setFileInput').click();
    }
    
    async function handleSetFiles(files) {
        if (!currentProject) {
            showToast('No project selected', 'error');
            return;
        }
        
        const setName = (currentSetFilter && currentSetFilter !== '__favorites__') ? currentSetFilter : null;
        const total = files.length;
        
        // Show popup
        const popup = document.getElementById('uploadPopup');
        const list = document.getElementById('uploadList');
        const title = document.getElementById('uploadTitle');
        const count = document.getElementById('uploadCount');
        
        popup.classList.add('show');
        popup.classList.remove('completed', 'collapsed');
        title.textContent = setName ? `Uploading to "${setName}"...` : 'Uploading...';
        count.textContent = `0 of ${total} items`;
        list.innerHTML = '';
        
        let completed = 0, failed = 0;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        async function uploadOne(file, idx) {
            const sizeKB = (file.size/1024).toFixed(0);
            const itemId = `up-${Date.now()}-${idx}`;
            
            // Add a simple row (no blob preview to save memory)
            const row = document.createElement('div');
            row.className = 'upload-popup-item';
            row.id = itemId;
            row.innerHTML = `
                <div class="upload-popup-item-icon" style="background:var(--gray-100);display:flex;align-items:center;justify-content:center;font-size:0.6rem;color:var(--gray-400);">IMG</div>
                <div class="upload-popup-item-info">
                    <div class="upload-popup-item-name">${file.name}</div>
                    <div class="upload-popup-item-meta">Uploading â€¢ ${sizeKB} KB</div>
                </div>
                <div class="upload-popup-item-status uploading" id="stat-${itemId}"></div>`;
            list.appendChild(row);
            
            try {
                let uploadData = null;
                for (let tryNum = 1; tryNum <= 5; tryNum++) {
                    const form = new FormData();
                    form.append('file', file, file.name);
                    form.append('projectId', currentProject.id);
                    form.append('projectSlug', currentProject.slug);
                    form.append('sortOrder', String(idx));
                    if (setName) form.append('set_name', setName);

                    const ur = await fetch(`${API_URL}/api/admin/upload/direct-with-id`, {
                        method: 'POST',
                        headers: { 'x-admin-key': ADMIN_PASSWORD },
                        body: form
                    });

                    if (ur.ok) {
                        uploadData = await ur.json();
                        break;
                    }
                    if (ur.status === 429 || ur.status >= 500 || ur.status === 408) {
                        await sleep(500 * tryNum);
                        continue;
                    }
                    throw new Error(`Upload failed (${ur.status})`);
                }
                if (!uploadData) throw new Error('Upload failed after retries');

                row.querySelector('.upload-popup-item-meta').textContent = `${uploadData.filename || file.name} â€¢ ${sizeKB} KB`;
                document.getElementById(`stat-${itemId}`).className = 'upload-popup-item-status done';
                document.getElementById(`stat-${itemId}`).innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>';
                completed++;
            } catch(err) {
                row.querySelector('.upload-popup-item-meta').textContent = 'Failed';
                document.getElementById(`stat-${itemId}`).className = 'upload-popup-item-status error';
                document.getElementById(`stat-${itemId}`).innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>';
                failed++;
            }
            count.textContent = `${completed} of ${total} items`;
        }
        
        // Strictly one-at-a-time to avoid duplicate filenames + R2 throttling
        const fileArr = [...files];
        for (let i = 0; i < fileArr.length; i++) {
            await uploadOne(fileArr[i], i);
            await sleep(120);
        }
        
        popup.classList.add('completed');
        title.textContent = 'Upload completed';
        count.textContent = failed ? `${completed} uploaded, ${failed} failed` : `${completed} items uploaded`;
        loadProjects();
        await reloadProjectPhotosKeepSet();
        document.getElementById('setFileInput').value='';
    }
    
    async function reloadProjectPhotosKeepSet() {
        const savedFilter = currentSetFilter;
        const savedManual = [...manualSets];
        const g = document.getElementById('photosGrid');
        g.innerHTML='<div class="loading"><div class="spinner"></div></div>';
        try {
            let d;
            try {
                const r=await fetch(`${API_URL}/api/admin/projects/${currentProject.id}/photos`,{headers:{'x-admin-key':ADMIN_PASSWORD}});
                d=await r.json();
            } catch(e) {
                const r2=await fetch(`${API_URL}/api/projects/${currentProject.slug}`);
                d=await r2.json();
            }
            currentPhotos=d.photos||d||[];
            if(!Array.isArray(currentPhotos))currentPhotos=[];
            
            manualSets = savedManual;
            selectSet(savedFilter);
        } catch(e) {
            g.innerHTML='<div class="empty-state"><p>Error loading photos</p></div>';
        }
    }
    
    function toggleUploadPopup() { document.getElementById('uploadPopup').classList.toggle('collapsed'); }
    function closeUploadPopup() { document.getElementById('uploadPopup').classList.remove('show'); }
    
    async function handleFiles(files){
        const projectId=document.getElementById('uploadProjectSelect').value;
        if(!projectId){showToast('Select collection first!','error');return;}
        const project=projects.find(p=>p.id===projectId);
        const total = files.length;
        
        // Show popup
        const popup = document.getElementById('uploadPopup');
        const list = document.getElementById('uploadList');
        const title = document.getElementById('uploadTitle');
        const count = document.getElementById('uploadCount');
        
        popup.classList.add('show');
        popup.classList.remove('completed', 'collapsed');
        title.textContent = 'Uploading...';
        count.textContent = `0 of ${total} items`;
        list.innerHTML = '';
        
        let completed = 0, failed = 0;
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        async function uploadOne(file, idx) {
            const sizeKB = (file.size/1024).toFixed(0);
            const itemId = `up-${Date.now()}-${idx}`;
            
            const row = document.createElement('div');
            row.className = 'upload-popup-item';
            row.id = itemId;
            row.innerHTML = `
                <div class="upload-popup-item-icon" style="background:var(--gray-100);display:flex;align-items:center;justify-content:center;font-size:0.6rem;color:var(--gray-400);">IMG</div>
                <div class="upload-popup-item-info">
                    <div class="upload-popup-item-name">${file.name}</div>
                    <div class="upload-popup-item-meta">Uploading â€¢ ${sizeKB} KB</div>
                </div>
                <div class="upload-popup-item-status uploading" id="stat-${itemId}"></div>`;
            list.appendChild(row);
            
            try {
                let uploadData = null;
                for (let tryNum = 1; tryNum <= 5; tryNum++) {
                    const form = new FormData();
                    form.append('file', file, file.name);
                    form.append('projectId', projectId);
                    form.append('projectSlug', project.slug);
                    form.append('sortOrder', String(idx));

                    const ur = await fetch(`${API_URL}/api/admin/upload/direct-with-id`, {
                        method: 'POST',
                        headers: { 'x-admin-key': ADMIN_PASSWORD },
                        body: form
                    });

                    if (ur.ok) {
                        uploadData = await ur.json();
                        break;
                    }
                    if (ur.status === 429 || ur.status >= 500 || ur.status === 408) {
                        await sleep(500 * tryNum);
                        continue;
                    }
                    throw new Error(`Upload failed (${ur.status})`);
                }
                if (!uploadData) throw new Error('Upload failed after retries');

                row.querySelector('.upload-popup-item-meta').textContent = `${uploadData.filename || file.name} â€¢ ${sizeKB} KB`;
                document.getElementById(`stat-${itemId}`).className = 'upload-popup-item-status done';
                document.getElementById(`stat-${itemId}`).innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9 12l2 2 4-4"/></svg>';
                completed++;
            } catch(err) {
                row.querySelector('.upload-popup-item-meta').textContent = 'Failed';
                document.getElementById(`stat-${itemId}`).className = 'upload-popup-item-status error';
                document.getElementById(`stat-${itemId}`).innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>';
                failed++;
            }
            count.textContent = `${completed} of ${total} items`;
        }
        
        // Strictly one-at-a-time to avoid duplicate filenames + R2 throttling
        const fileArr = [...files];
        for (let i = 0; i < fileArr.length; i++) {
            await uploadOne(fileArr[i], i);
            await sleep(120);
        }
        
        popup.classList.add('completed');
        title.textContent = 'Upload completed';
        count.textContent = failed ? `${completed} uploaded, ${failed} failed` : `${completed} items uploaded`;
        loadProjects();
        if(currentProject) loadProjectPhotos();
        document.getElementById('fileInput').value='';
    }
    
    async function loadOrders(){const el=document.getElementById('ordersList');try{const r=await fetch(`${API_URL}/api/admin/orders`,{headers:{'x-admin-key':ADMIN_PASSWORD}});const d=await r.json();if(!d.orders?.length){el.innerHTML='<div class="empty-state"><p>No orders yet</p></div>';return;}el.innerHTML=`<table style="width:100%;border-collapse:collapse;background:white;border-radius:8px;overflow:hidden;"><thead><tr style="background:var(--gray-50);text-align:left;"><th style="padding:0.75rem 1rem;font-size:0.8rem;font-weight:600;">Order</th><th style="padding:0.75rem 1rem;font-size:0.8rem;font-weight:600;">Date</th><th style="padding:0.75rem 1rem;font-size:0.8rem;font-weight:600;">Customer</th><th style="padding:0.75rem 1rem;font-size:0.8rem;font-weight:600;">Total</th><th style="padding:0.75rem 1rem;font-size:0.8rem;font-weight:600;">Status</th></tr></thead><tbody>${d.orders.map(o=>`<tr style="border-top:1px solid var(--gray-200);"><td style="padding:0.75rem 1rem;font-weight:500;">${o.order_number||o.id.slice(0,8)}</td><td style="padding:0.75rem 1rem;color:var(--gray-600);">${new Date(o.created_at).toLocaleDateString()}</td><td style="padding:0.75rem 1rem;">${o.customer_email||'-'}</td><td style="padding:0.75rem 1rem;font-weight:500;">$${((o.total_amount||0)/100).toFixed(2)}</td><td style="padding:0.75rem 1rem;"><span style="background:${o.status==='completed'?'var(--success)':'var(--gray-400)'};color:white;padding:0.2rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:600;">${o.status}</span></td></tr>`).join('')}</tbody></table>`;}catch(e){el.innerHTML='<div class="empty-state"><p>Error</p></div>';}}
    
    function generateCode(inputId){const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let code='';for(let i=0;i<4;i++)code+=chars[Math.floor(Math.random()*chars.length)];code+='-';for(let i=0;i<4;i++)code+=chars[Math.floor(Math.random()*chars.length)];document.getElementById(inputId).value=code;}
    
    function formatDateRange(startDate, endDate) {
        if (!startDate) return 'No date';
        const start = new Date(startDate);
        const startMonth = start.toLocaleDateString('en-US', { month: 'short' });
        const startDay = start.getDate();
        const startYear = start.getFullYear();
        
        if (!endDate) {
            return `${startMonth} ${startDay}, ${startYear}`;
        }
        
        const end = new Date(endDate);
        const endMonth = end.toLocaleDateString('en-US', { month: 'short' });
        const endDay = end.getDate();
        const endYear = end.getFullYear();
        
        // Same month and year
        if (startMonth === endMonth && startYear === endYear) {
            return `${startMonth} ${startDay}-${endDay}, ${startYear}`;
        }
        // Same year, different month
        if (startYear === endYear) {
            return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${startYear}`;
        }
        // Different years
        return `${startMonth} ${startDay}, ${startYear} - ${endMonth} ${endDay}, ${endYear}`;
    }
    
    function showToast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+type;setTimeout(()=>t.classList.remove('show'),3000);}
    
    // ==================== SEO FUNCTIONS ====================
    
    // Initialize SEO inputs with live preview
    document.addEventListener('DOMContentLoaded', function() {
        const titleInput = document.getElementById('seoTitle');
        const descInput = document.getElementById('seoDescription');
        
        if (titleInput) {
            titleInput.addEventListener('input', function() {
                document.getElementById('seoTitleCount').textContent = this.value.length;
                updateSeoPreview();
            });
        }
        if (descInput) {
            descInput.addEventListener('input', function() {
                document.getElementById('seoDescCount').textContent = this.value.length;
                updateSeoPreview();
            });
        }
    });
    
    function updateSeoPreview() {
        const title = document.getElementById('seoTitle')?.value || currentProject?.title || 'Page Title';
        const desc = document.getElementById('seoDescription')?.value || 'Meta description will appear here...';
        const slug = currentProject?.slug || 'project';
        
        document.getElementById('previewTitle').textContent = title || 'Page Title';
        document.getElementById('previewUrl').textContent = `sfeventphoto.com/project/${slug}`;
        document.getElementById('previewDesc').textContent = desc;
        
        // Auto-generate schema
        generateSchema();
    }
    
    function generateSeoSuggestions() {
        if (!currentProject) return;
        
        const p = currentProject;
        const brands = (p.brands || []).join(', ');
        const date = p.event_date ? new Date(p.event_date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '';
        const venue = p.venue || 'San Francisco';
        
        // Generate title (under 60 chars)
        let title = `${p.title} Photos`;
        if (title.length < 45 && venue) {
            title = `${p.title} Photos | ${venue}`;
        }
        if (title.length > 60) title = title.substring(0, 57) + '...';
        
        // Generate description (under 160 chars)
        let desc = `SF Event Photo captured ${p.title}`;
        if (date) desc += ` on ${date}`;
        if (venue) desc += ` at ${venue}`;
        desc += '. Professional event photography coverage.';
        if (brands && desc.length + brands.length + 15 < 160) {
            desc += ` Featuring ${brands}.`;
        }
        if (desc.length > 160) desc = desc.substring(0, 157) + '...';
        
        // Generate keywords
        let keywords = [p.title.toLowerCase()];
        if (venue) keywords.push(venue.toLowerCase());
        if (brands) keywords = keywords.concat(p.brands.map(b => b.toLowerCase()));
        keywords.push('event photos', 'professional photography', 'high resolution');
        
        // Set values
        document.getElementById('seoTitle').value = title;
        document.getElementById('seoDescription').value = desc;
        document.getElementById('seoKeywords').value = keywords.slice(0, 8).join(', ');
        
        // Update counts
        document.getElementById('seoTitleCount').textContent = title.length;
        document.getElementById('seoDescCount').textContent = desc.length;
        
        updateSeoPreview();
        showToast('SEO suggestions generated!', 'success');
    }
    
    function generateSchema() {
        if (!currentProject) return;
        
        const p = currentProject;
        const baseUrl = 'https://sfeventphoto.com';
        
        // Create ImageGallery + Event combined schema
        const schema = {
            "@context": "https://schema.org",
            "@type": "ImageGallery",
            "name": document.getElementById('seoTitle')?.value || p.title,
            "description": document.getElementById('seoDescription')?.value || p.description || `Professional photos from ${p.title}`,
            "url": `${baseUrl}/project/${p.slug}`,
            "numberOfItems": p.photo_count || 0,
            "datePublished": p.created_at,
            "dateModified": p.updated_at || p.created_at,
            "image": p.cover_image_url || '',
            "author": {
                "@type": "Organization",
                "name": "SF Event Photo",
                "url": baseUrl
            }
        };
        
        // Add event info if we have date/venue
        if (p.event_date || p.venue) {
            schema["about"] = {
                "@type": "Event",
                "name": p.title,
                "startDate": p.event_date || undefined,
                "location": p.venue ? {
                    "@type": "Place",
                    "name": p.venue,
                    "address": {
                        "@type": "PostalAddress",
                        "addressLocality": "San Francisco",
                        "addressRegion": "CA",
                        "addressCountry": "US"
                    }
                } : undefined
            };
            // Clean undefined values
            if (!schema.about.startDate) delete schema.about.startDate;
            if (!schema.about.location) delete schema.about.location;
        }
        
        // Add brands as mentions
        if (p.brands && p.brands.length > 0) {
            schema["mentions"] = p.brands.map(brand => ({
                "@type": "Brand",
                "name": brand
            }));
        }
        
        // Add keywords
        const keywords = document.getElementById('seoKeywords')?.value;
        if (keywords) {
            schema["keywords"] = keywords;
        }
        
        const schemaText = JSON.stringify(schema, null, 2);
        document.getElementById('seoSchema').value = schemaText;
        
        return schema;
    }
    
    function copySchema() {
        const schema = document.getElementById('seoSchema').value;
        const fullScript = `<script type="application/ld+json">\n${schema}\n<\/script>`;
        
        navigator.clipboard.writeText(fullScript).then(() => {
            showToast('Schema copied! Paste in your page <head>', 'success');
        }).catch(() => {
            // Fallback
            const ta = document.createElement('textarea');
            ta.value = fullScript;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            showToast('Schema copied!', 'success');
        });
    }
    
    async function saveSeoData() {
        if (!currentProject) return;
        
        const seoData = {
            seo_title: document.getElementById('seoTitle').value || null,
            seo_description: document.getElementById('seoDescription').value || null,
            seo_keywords: document.getElementById('seoKeywords').value || null
        };
        
        try {
            await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'x-admin-key': ADMIN_PASSWORD },
                body: JSON.stringify(seoData)
            });
            
            // Update local project
            currentProject.seo_title = seoData.seo_title;
            currentProject.seo_description = seoData.seo_description;
            currentProject.seo_keywords = seoData.seo_keywords;
            
            showToast('SEO data saved!', 'success');
        } catch (e) {
            showToast('Error saving SEO data', 'error');
        }
    }
    
    function loadSeoData() {
        if (!currentProject) return;
        
        const p = currentProject;
        document.getElementById('seoTitle').value = p.seo_title || '';
        document.getElementById('seoDescription').value = p.seo_description || '';
        document.getElementById('seoKeywords').value = p.seo_keywords || '';
        
        document.getElementById('seoTitleCount').textContent = (p.seo_title || '').length;
        document.getElementById('seoDescCount').textContent = (p.seo_description || '').length;
        
        updateSeoPreview();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PREVIEW MODE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let previewMode = false;
    let previewSelectedPhotos = new Set();
    let previewPhotos = [];
    let previewDragSrcIndex = null;
    
    function togglePreviewMode() {
        previewMode = !previewMode;
        const panel = document.getElementById('previewModePanel');
        const btn = document.getElementById('previewModeBtn');
        
        if (previewMode) {
            panel.classList.add('active');
            btn.textContent = 'âœ• Exit Preview';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
            previewSelectedPhotos.clear();
            renderPreviewGrid();
        } else {
            panel.classList.remove('active');
            btn.textContent = 'ðŸ‘ Preview';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
            // Refresh the main photos area
            loadProjectPhotos(currentProject.id);
        }
    }
    
    async function renderPreviewGrid() {
        const grid = document.getElementById('previewGrid');
        const header = document.getElementById('previewHeader');
        
        // Render project header like actual project page
        const dateStr = currentProject.event_date ? formatDateRange(currentProject.event_date, currentProject.event_end_date) : '';
        header.innerHTML = `
            <div class="preview-header-date">${dateStr}</div>
            <h1 class="preview-header-title">${currentProject.title || 'Untitled Project'}</h1>
            ${currentProject.venue ? `<div class="preview-header-venue">${currentProject.venue}</div>` : ''}
            <div class="preview-header-credits">Â© SF Event Photo</div>
        `;
        
        // Use already loaded photos from currentPhotos
        previewPhotos = [...currentPhotos].sort((a,b) => (a.sort_order||0) - (b.sort_order||0));
        
        if (previewPhotos.length === 0) {
            grid.innerHTML = '<div style="color:var(--gray-400);padding:3rem;text-align:center;">No photos in this project yet.</div>';
            return;
        }
        
        grid.innerHTML = previewPhotos.map((photo, index) => `
            <div class="preview-photo ${previewSelectedPhotos.has(photo.id) ? 'selected' : ''}" 
                 data-id="${photo.id}" 
                 data-index="${index}"
                 onclick="togglePreviewSelect(${photo.id}, event)"
                 draggable="true"
                 ondragstart="previewDragStart(event, ${index})"
                 ondragover="previewDragOver(event)"
                 ondragenter="previewDragEnter(event)"
                 ondragleave="previewDragLeave(event)"
                 ondrop="previewDrop(event, ${index})"
                 ondragend="previewDragEnd(event)">
                <img src="${photo.thumbnail_url || photo.url}" alt="" loading="lazy">
                <span class="preview-photo-number">${index + 1}</span>
                <div class="preview-photo-check">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <div class="preview-photo-actions">
                    <button class="preview-photo-action" onclick="event.stopPropagation(); setCoverFromPreview(${photo.id})" title="Set as cover">â­</button>
                    <button class="preview-photo-action delete" onclick="event.stopPropagation(); deleteSinglePreview(${photo.id})" title="Delete">ðŸ—‘</button>
                </div>
            </div>
        `).join('');
        
        updatePreviewSelectedCount();
    }
    
    function togglePreviewSelect(photoId, event) {
        if (event.shiftKey && previewSelectedPhotos.size > 0) {
            // Shift-click for range selection
            const lastSelected = Array.from(previewSelectedPhotos).pop();
            const lastIndex = previewPhotos.findIndex(p => p.id === lastSelected);
            const currentIndex = previewPhotos.findIndex(p => p.id === photoId);
            const [start, end] = [Math.min(lastIndex, currentIndex), Math.max(lastIndex, currentIndex)];
            for (let i = start; i <= end; i++) {
                previewSelectedPhotos.add(previewPhotos[i].id);
            }
        } else if (event.ctrlKey || event.metaKey) {
            // Ctrl/Cmd-click for toggle individual
            if (previewSelectedPhotos.has(photoId)) {
                previewSelectedPhotos.delete(photoId);
            } else {
                previewSelectedPhotos.add(photoId);
            }
        } else {
            // Regular click - toggle single
            if (previewSelectedPhotos.has(photoId) && previewSelectedPhotos.size === 1) {
                previewSelectedPhotos.clear();
            } else {
                previewSelectedPhotos.clear();
                previewSelectedPhotos.add(photoId);
            }
        }
        
        // Update UI
        document.querySelectorAll('.preview-photo').forEach(el => {
            const id = parseInt(el.dataset.id);
            el.classList.toggle('selected', previewSelectedPhotos.has(id));
        });
        
        updatePreviewSelectedCount();
    }
    
    function updatePreviewSelectedCount() {
        const count = previewSelectedPhotos.size;
        document.getElementById('previewSelectedCount').textContent = `${count} selected`;
        document.getElementById('previewDeleteBtn').disabled = count === 0;
    }
    
    function selectAllPreview() {
        previewPhotos.forEach(p => previewSelectedPhotos.add(p.id));
        document.querySelectorAll('.preview-photo').forEach(el => el.classList.add('selected'));
        updatePreviewSelectedCount();
    }
    
    function deselectAllPreview() {
        previewSelectedPhotos.clear();
        document.querySelectorAll('.preview-photo').forEach(el => el.classList.remove('selected'));
        updatePreviewSelectedCount();
    }
    
    async function deleteSelectedPreview() {
        if (previewSelectedPhotos.size === 0) return;
        
        const count = previewSelectedPhotos.size;
        if (!confirm(`Delete ${count} photo${count > 1 ? 's' : ''}? This cannot be undone.`)) return;
        
        try {
            const ids = Array.from(previewSelectedPhotos);
            
            // Delete each photo via API
            for (const id of ids) {
                await fetch(`${API_URL}/api/admin/photos/${id}`, {
                    method: 'DELETE',
                    headers: { 'x-admin-key': ADMIN_PASSWORD }
                });
            }
            
            showToast(`Deleted ${count} photo${count > 1 ? 's' : ''}`, 'success');
            previewSelectedPhotos.clear();
            
            // Reload photos and re-render
            await loadProjectPhotos();
            renderPreviewGrid();
            
            // Update photo count
            document.getElementById('projectMeta').textContent = `${currentPhotos.length} photos`;
        } catch (err) {
            console.error('Error deleting photos:', err);
            showToast('Error deleting photos', 'error');
        }
    }
    
    async function deleteSinglePreview(photoId) {
        if (!confirm('Delete this photo? This cannot be undone.')) return;
        
        try {
            await fetch(`${API_URL}/api/admin/photos/${photoId}`, {
                method: 'DELETE',
                headers: { 'x-admin-key': ADMIN_PASSWORD }
            });
            
            showToast('Photo deleted', 'success');
            previewSelectedPhotos.delete(photoId);
            
            // Reload photos and re-render
            await loadProjectPhotos();
            renderPreviewGrid();
            
            document.getElementById('projectMeta').textContent = `${currentPhotos.length} photos`;
        } catch (err) {
            console.error('Error deleting photo:', err);
            showToast('Error deleting photo', 'error');
        }
    }
    
    async function setCoverFromPreview(photoId) {
        const photo = previewPhotos.find(p => p.id === photoId);
        if (!photo) return;
        
        try {
            await fetch(`${API_URL}/api/admin/projects/${currentProject.id}`, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-admin-key': ADMIN_PASSWORD 
                },
                body: JSON.stringify({ cover_image_url: photo.url })
            });
            
            currentProject.cover_image_url = photo.url;
            document.getElementById('projectCover').src = photo.url;
            showToast('Cover image updated', 'success');
        } catch (err) {
            console.error('Error setting cover:', err);
            showToast('Error setting cover', 'error');
        }
    }
    
    // Preview drag and drop for reordering
    function previewDragStart(e, index) {
        previewDragSrcIndex = index;
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
    }
    
    function previewDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    }
    
    function previewDragEnter(e) {
        e.target.closest('.preview-photo')?.classList.add('drag-over');
    }
    
    function previewDragLeave(e) {
        e.target.closest('.preview-photo')?.classList.remove('drag-over');
    }
    
    function previewDragEnd(e) {
        document.querySelectorAll('.preview-photo').forEach(el => {
            el.classList.remove('dragging', 'drag-over');
        });
        previewDragSrcIndex = null;
    }
    
    async function previewDrop(e, targetIndex) {
        e.preventDefault();
        e.target.closest('.preview-photo')?.classList.remove('drag-over');
        
        if (previewDragSrcIndex === null || previewDragSrcIndex === targetIndex) return;
        
        // Reorder array
        const [moved] = previewPhotos.splice(previewDragSrcIndex, 1);
        previewPhotos.splice(targetIndex, 0, moved);
        
        // Update currentPhotos to match immediately
        currentPhotos = [...previewPhotos];
        
        // Re-render immediately so user sees the change
        renderPreviewGrid();
        
        // Update sort_order via API in background
        try {
            const order = previewPhotos.map((photo, idx) => ({
                id: photo.id,
                sort_order: idx
            }));
            
            await fetch(`${API_URL}/api/admin/photos/reorder`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-admin-key': ADMIN_PASSWORD 
                },
                body: JSON.stringify({ order })
            });
            
            showToast('Order updated', 'success');
        } catch (err) {
            console.error('Error updating order:', err);
            showToast('Error updating order', 'error');
        }
    }
    
    // Keyboard shortcut for delete
    document.addEventListener('keydown', (e) => {
        if (!previewMode) return;
        
        if ((e.key === 'Delete' || e.key === 'Backspace') && previewSelectedPhotos.size > 0) {
            e.preventDefault();
            deleteSelectedPreview();
        }
        
        if (e.key === 'Escape') {
            togglePreviewMode();
        }
        
        if (e.key === 'a' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            selectAllPreview();
        }
    });
    </script>
</body>
</html>
